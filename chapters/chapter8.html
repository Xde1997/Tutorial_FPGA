
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>第8章：函数式HDL之Haskell/Clash · FPGA原理与AI加速应用教程</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="FPGA教程团队">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
        <link rel="stylesheet" href="../assets/css/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="chapter9.html" />
    
    
    <link rel="prev" href="chapter7.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                        <b>1.1.</b>
                    
                    介绍
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第一部分：FPGA基础架构</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="chapter1.html">
            
                <a href="chapter1.html">
            
                    
                        <b>2.1.</b>
                    
                    第1章：FPGA基础架构与工作原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="chapter2.html">
            
                <a href="chapter2.html">
            
                    
                        <b>2.2.</b>
                    
                    第2章：HDL设计基础与方法学
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="chapter3.html">
            
                <a href="chapter3.html">
            
                    
                        <b>2.3.</b>
                    
                    第3章：时序、时钟与同步
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="chapter4.html">
            
                <a href="chapter4.html">
            
                    
                        <b>2.4.</b>
                    
                    第4章：存储器系统与接口设计
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第二部分：高级设计技术</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="chapter5.html">
            
                <a href="chapter5.html">
            
                    
                        <b>3.1.</b>
                    
                    第5章：高速I/O与通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="chapter6.html">
            
                <a href="chapter6.html">
            
                    
                        <b>3.2.</b>
                    
                    第6章：DSP与算术优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="chapter7.html">
            
                <a href="chapter7.html">
            
                    
                        <b>3.3.</b>
                    
                    第7章：HLS与C到硬件综合
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="3.4" data-path="chapter8.html">
            
                <a href="chapter8.html">
            
                    
                        <b>3.4.</b>
                    
                    第8章：函数式HDL之Haskell/Clash
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.5" data-path="chapter9.html">
            
                <a href="chapter9.html">
            
                    
                        <b>3.5.</b>
                    
                    第9章：OCaml/Hardcaml硬件设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.6" data-path="chapter10.html">
            
                <a href="chapter10.html">
            
                    
                        <b>3.6.</b>
                    
                    第10章：零知识证明加速器
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第三部分：AI加速实战</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="chapter11.html">
            
                <a href="chapter11.html">
            
                    
                        <b>4.1.</b>
                    
                    第11章：AI加速器基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="chapter12.html">
            
                <a href="chapter12.html">
            
                    
                        <b>4.2.</b>
                    
                    第12章：LLM推理加速
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.3" data-path="chapter13.html">
            
                <a href="chapter13.html">
            
                    
                        <b>4.3.</b>
                    
                    第13章：视觉与多模态处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.4" data-path="chapter14.html">
            
                <a href="chapter14.html">
            
                    
                        <b>4.4.</b>
                    
                    第14章：LLM服务基础设施
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.5" data-path="chapter15.html">
            
                <a href="chapter15.html">
            
                    
                        <b>4.5.</b>
                    
                    第15章：机器人运动控制与FPGA
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.6" data-path="chapter16.html">
            
                <a href="chapter16.html">
            
                    
                        <b>4.6.</b>
                    
                    第16章：激光雷达信号处理与FPGA
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.7" data-path="chapter17.html">
            
                <a href="chapter17.html">
            
                    
                        <b>4.7.</b>
                    
                    第17章：毫米波雷达与FPGA
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">第四部分：高级优化与扩展</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="chapter18.html">
            
                <a href="chapter18.html">
            
                    
                        <b>5.1.</b>
                    
                    第18章：性能分析与优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.2" data-path="chapter19.html">
            
                <a href="chapter19.html">
            
                    
                        <b>5.2.</b>
                    
                    第19章：功耗优化技术
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.3" data-path="chapter20.html">
            
                <a href="chapter20.html">
            
                    
                        <b>5.3.</b>
                    
                    第20章：多FPGA系统与扩展
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.4" data-path="chapter21.html">
            
                <a href="chapter21.html">
            
                    
                        <b>5.4.</b>
                    
                    第21章：可靠性与容错设计
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.5" data-path="chapter22.html">
            
                <a href="chapter22.html">
            
                    
                        <b>5.5.</b>
                    
                    第22章：未来趋势与新兴技术
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../docs/DEPLOY_README.md">
            
                <span>
            
                    
                        <b>6.1.</b>
                    
                    部署指南
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.2" data-path="../docs/GITBOOK_SETUP.md">
            
                <span>
            
                    
                        <b>6.2.</b>
                    
                    安装说明
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="6.3" data-path="../docs/CONVERSION_SUMMARY.md">
            
                <span>
            
                    
                        <b>6.3.</b>
                    
                    转换总结
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >第8章：函数式HDL之Haskell/Clash</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="&#x7B2C;8&#x7AE0;&#xFF1A;&#x51FD;&#x6570;&#x5F0F;hdl&#x4E4B;haskellclash">&#x7B2C;8&#x7AE0;&#xFF1A;&#x51FD;&#x6570;&#x5F0F;HDL&#x4E4B;Haskell/Clash</h1>
<p>&#x5728;&#x4F20;&#x7EDF;HDL&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x5DE5;&#x7A0B;&#x5E08;&#x9700;&#x8981;&#x5728;&#x5E95;&#x5C42;&#x7EC6;&#x8282;&#x4E0E;&#x9AD8;&#x5C42;&#x62BD;&#x8C61;&#x4E4B;&#x95F4;&#x4E0D;&#x65AD;&#x5207;&#x6362;&#x3002;Verilog&#x548C;VHDL&#x867D;&#x7136;&#x5F3A;&#x5927;&#xFF0C;&#x4F46;&#x5176;&#x547D;&#x4EE4;&#x5F0F;&#x7F16;&#x7A0B;&#x8303;&#x5F0F;&#x5F80;&#x5F80;&#x5BFC;&#x81F4;&#x5197;&#x957F;&#x4E14;&#x5BB9;&#x6613;&#x51FA;&#x9519;&#x7684;&#x4EE3;&#x7801;&#x3002;&#x672C;&#x7AE0;&#x5C06;&#x4ECB;&#x7ECD;&#x51FD;&#x6570;&#x5F0F;&#x786C;&#x4EF6;&#x63CF;&#x8FF0;&#x8BED;&#x8A00;Clash&#xFF0C;&#x5B83;&#x57FA;&#x4E8E;Haskell&#x6784;&#x5EFA;&#xFF0C;&#x901A;&#x8FC7;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x3001;&#x9AD8;&#x9636;&#x51FD;&#x6570;&#x548C;&#x7EAF;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#x8303;&#x5F0F;&#xFF0C;&#x8BA9;&#x786C;&#x4EF6;&#x8BBE;&#x8BA1;&#x66F4;&#x63A5;&#x8FD1;&#x6570;&#x5B66;&#x5EFA;&#x6A21;&#x7684;&#x672C;&#x8D28;&#x3002;&#x6211;&#x4EEC;&#x5C06;&#x6DF1;&#x5165;&#x63A2;&#x8BA8;&#x5982;&#x4F55;&#x5229;&#x7528;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#x7684;&#x4F18;&#x52BF;&#x6765;&#x6784;&#x5EFA;&#x53EF;&#x7EC4;&#x5408;&#x3001;&#x53EF;&#x9A8C;&#x8BC1;&#x7684;&#x786C;&#x4EF6;&#x6A21;&#x5757;&#xFF0C;&#x5E76;&#x4EE5;&#x5B9E;&#x73B0;EVM&#xFF08;&#x4EE5;&#x592A;&#x574A;&#x865A;&#x62DF;&#x673A;&#xFF09;&#x5B57;&#x8282;&#x7801;&#x6267;&#x884C;&#x5F15;&#x64CE;&#x4E3A;&#x6848;&#x4F8B;&#xFF0C;&#x5C55;&#x793A;Clash&#x5728;&#x590D;&#x6742;&#x72B6;&#x6001;&#x673A;&#x8BBE;&#x8BA1;&#x4E2D;&#x7684;&#x5A01;&#x529B;&#x3002;</p>
<h2 id="81-&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;&#x786C;&#x4EF6;&#x63CF;&#x8FF0;">8.1 &#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;&#x786C;&#x4EF6;&#x63CF;&#x8FF0;</h2>
<h3 id="811-&#x4E3A;&#x4EC0;&#x4E48;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x5BF9;&#x786C;&#x4EF6;&#x8BBE;&#x8BA1;&#x81F3;&#x5173;&#x91CD;&#x8981;">8.1.1 &#x4E3A;&#x4EC0;&#x4E48;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x5BF9;&#x786C;&#x4EF6;&#x8BBE;&#x8BA1;&#x81F3;&#x5173;&#x91CD;&#x8981;</h3>
<p>&#x5728;&#x4F20;&#x7EDF;HDL&#x4E2D;&#xFF0C;&#x4F4D;&#x5BBD;&#x4E0D;&#x5339;&#x914D;&#x3001;&#x4FE1;&#x53F7;&#x8FDE;&#x63A5;&#x9519;&#x8BEF;&#x7B49;&#x95EE;&#x9898;&#x5F80;&#x5F80;&#x8981;&#x5230;&#x4EFF;&#x771F;&#x6216;&#x7EFC;&#x5408;&#x9636;&#x6BB5;&#x624D;&#x80FD;&#x53D1;&#x73B0;&#x3002;Clash&#x901A;&#x8FC7;Haskell&#x7684;&#x5F3A;&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#xFF0C;&#x5C06;&#x8FD9;&#x4E9B;&#x9519;&#x8BEF;&#x63D0;&#x524D;&#x5230;&#x7F16;&#x8BD1;&#x65F6;&#x6355;&#x83B7;&#x3002;</p>
<p><strong>&#x6838;&#x5FC3;&#x6982;&#x5FF5;&#xFF1A;&#x4F9D;&#x8D56;&#x7C7B;&#x578B;&#x4E0E;&#x4F4D;&#x5BBD;&#x63A8;&#x5BFC;</strong></p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- Clash&#x4E2D;&#x7684;&#x5411;&#x91CF;&#x7C7B;&#x578B;&#x81EA;&#x5E26;&#x957F;&#x5EA6;&#x4FE1;&#x606F;</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Word8</span> = <span class="hljs-type">BitVector</span> 8</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Word32</span> = <span class="hljs-type">BitVector</span> 32</span>

<span class="hljs-comment">-- &#x7F16;&#x8BD1;&#x65F6;&#x4FDD;&#x8BC1;&#x4F4D;&#x5BBD;&#x5339;&#x914D;</span>
<span class="hljs-title">add</span> :: <span class="hljs-type">Signal</span> dom <span class="hljs-type">Word8</span> -&gt; <span class="hljs-type">Signal</span> dom <span class="hljs-type">Word8</span> -&gt; <span class="hljs-type">Signal</span> dom <span class="hljs-type">Word9</span>
<span class="hljs-title">add</span> a b = resize &lt;$&gt; a + resize &lt;$&gt; b
</code></pre>
<p><strong>&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x7684;&#x786C;&#x4EF6;&#x8BBE;&#x8BA1;&#x4F18;&#x52BF;</strong>&#xFF1A;</p>
<ol>
<li><p><strong>&#x7F16;&#x8BD1;&#x65F6;&#x9519;&#x8BEF;&#x68C0;&#x6D4B;</strong>&#xFF1A;</p>
<ul>
<li>&#x4F4D;&#x5BBD;&#x4E0D;&#x5339;&#x914D;&#x7ACB;&#x5373;&#x88AB;&#x53D1;&#x73B0;</li>
<li>&#x65F6;&#x949F;&#x57DF;&#x6DF7;&#x7528;&#x5728;&#x7C7B;&#x578B;&#x68C0;&#x67E5;&#x9636;&#x6BB5;&#x62A5;&#x9519;</li>
<li>&#x534F;&#x8BAE;&#x8FDD;&#x89C4;&#xFF08;&#x5982;AXI&#x63E1;&#x624B;&#xFF09;&#x901A;&#x8FC7;&#x7C7B;&#x578B;&#x7EA6;&#x675F;&#x9884;&#x9632;</li>
</ul>
</li>
<li><p><strong>&#x96F6;&#x8FD0;&#x884C;&#x65F6;&#x5F00;&#x9500;</strong>&#xFF1A;</p>
<ul>
<li>&#x7C7B;&#x578B;&#x4FE1;&#x606F;&#x4EC5;&#x5B58;&#x5728;&#x4E8E;&#x7F16;&#x8BD1;&#x671F;</li>
<li>&#x751F;&#x6210;&#x7684;Verilog&#x4E0E;&#x624B;&#x5199;&#x4EE3;&#x7801;&#x6027;&#x80FD;&#x76F8;&#x540C;</li>
<li>&#x7C7B;&#x578B;&#x63A8;&#x5BFC;&#x4E0D;&#x5F15;&#x5165;&#x989D;&#x5916;&#x786C;&#x4EF6;</li>
</ul>
</li>
<li><p><strong>&#x91CD;&#x6784;&#x5B89;&#x5168;&#x6027;</strong>&#xFF1A;</p>
<ul>
<li>&#x4FEE;&#x6539;&#x63A5;&#x53E3;&#x4F4D;&#x5BBD;&#xFF0C;&#x6240;&#x6709;&#x76F8;&#x5173;&#x6A21;&#x5757;&#x81EA;&#x52A8;&#x6807;&#x8BB0;</li>
<li>&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x5145;&#x5F53;&quot;&#x7F16;&#x8BD1;&#x5668;&#x7EA7;&#x522B;&#x7684;&#x8BBE;&#x8BA1;&#x89C4;&#x5219;&#x68C0;&#x67E5;&quot;</li>
</ul>
</li>
</ol>
<p><strong>&#x5E94;&#x7528;&#x5B9E;&#x4F8B;&#xFF1A;RISC-V&#x6307;&#x4EE4;&#x89E3;&#x7801;&#x5668;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;</strong></p>
<ol>
<li><p><strong>&#x6307;&#x4EE4;&#x683C;&#x5F0F;&#x5EFA;&#x6A21;</strong>&#xFF1A;&#x4F7F;&#x7528;ADT&#xFF08;&#x4EE3;&#x6570;&#x6570;&#x636E;&#x7C7B;&#x578B;&#xFF09;&#x8868;&#x793A;&#x4E0D;&#x540C;&#x6307;&#x4EE4;&#x683C;&#x5F0F;</p>
<ul>
<li>R&#x578B;&#x3001;I&#x578B;&#x3001;S&#x578B;&#x7B49;&#x6307;&#x4EE4;&#x683C;&#x5F0F;&#x4F5C;&#x4E3A;&#x4E0D;&#x540C;&#x7684;&#x7C7B;&#x578B;&#x6784;&#x9020;&#x5668;</li>
<li>&#x6BCF;&#x4E2A;&#x5B57;&#x6BB5;&#xFF08;opcode&#x3001;rd&#x3001;rs1&#x7B49;&#xFF09;&#x90FD;&#x6709;&#x660E;&#x786E;&#x7684;&#x4F4D;&#x5BBD;&#x7C7B;&#x578B;</li>
</ul>
<pre><code class="lang-haskell"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">RVInstr</span></span>
  = <span class="hljs-type">RType</span> { opcode :: <span class="hljs-type">BitVector</span> <span class="hljs-number">7</span>
          , rd     :: <span class="hljs-type">BitVector</span> <span class="hljs-number">5</span>
          , funct3 :: <span class="hljs-type">BitVector</span> <span class="hljs-number">3</span>
          , rs1    :: <span class="hljs-type">BitVector</span> <span class="hljs-number">5</span>
          , rs2    :: <span class="hljs-type">BitVector</span> <span class="hljs-number">5</span>
          , funct7 :: <span class="hljs-type">BitVector</span> <span class="hljs-number">7</span>
          }
  | <span class="hljs-type">IType</span> { opcode :: <span class="hljs-type">BitVector</span> <span class="hljs-number">7</span>
          , rd     :: <span class="hljs-type">BitVector</span> <span class="hljs-number">5</span>
          , funct3 :: <span class="hljs-type">BitVector</span> <span class="hljs-number">3</span>
          , rs1    :: <span class="hljs-type">BitVector</span> <span class="hljs-number">5</span>
          , imm    :: <span class="hljs-type">BitVector</span> <span class="hljs-number">12</span>
          }
  <span class="hljs-comment">-- &#x5176;&#x4ED6;&#x683C;&#x5F0F;...</span>
</code></pre>
</li>
<li><p><strong>&#x6A21;&#x5F0F;&#x5339;&#x914D;&#x89E3;&#x7801;</strong>&#xFF1A;&#x5229;&#x7528;Haskell&#x7684;&#x6A21;&#x5F0F;&#x5339;&#x914D;&#x5B9E;&#x73B0;&#x4F18;&#x96C5;&#x7684;&#x89E3;&#x7801;&#x903B;&#x8F91;</p>
<ul>
<li>&#x7F16;&#x8BD1;&#x5668;&#x81EA;&#x52A8;&#x68C0;&#x67E5;&#x662F;&#x5426;&#x8986;&#x76D6;&#x6240;&#x6709;&#x6307;&#x4EE4;&#x7C7B;&#x578B;</li>
<li>&#x4E0D;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x672A;&#x5B9A;&#x4E49;&#x6307;&#x4EE4;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x9519;&#x8BEF;</li>
<li>&#x975E;&#x7A77;&#x5C3D;&#x5339;&#x914D;&#x4F1A;&#x89E6;&#x53D1;&#x7F16;&#x8BD1;&#x8B66;&#x544A;</li>
</ul>
</li>
<li><p><strong>&#x7C7B;&#x578B;&#x9A71;&#x52A8;&#x7684;&#x6D41;&#x6C34;&#x7EBF;&#x8BBE;&#x8BA1;</strong>&#xFF1A;</p>
<ul>
<li>&#x6BCF;&#x4E2A;&#x6D41;&#x6C34;&#x7EBF;&#x9636;&#x6BB5;&#x7684;&#x8F93;&#x5165;&#x8F93;&#x51FA;&#x7C7B;&#x578B;&#x7CBE;&#x786E;&#x5B9A;&#x4E49;</li>
<li>&#x9636;&#x6BB5;&#x95F4;&#x6570;&#x636E;&#x4F20;&#x9012;&#x7684;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x4FDD;&#x8BC1;</li>
<li>&#x63A7;&#x5236;&#x5192;&#x9669;&#x901A;&#x8FC7;&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x7F16;&#x7801;</li>
</ul>
</li>
</ol>
<p><strong>&#x6DF1;&#x5165;&#x6848;&#x4F8B;&#xFF1A;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;Cache&#x63A7;&#x5236;&#x5668;</strong></p>
<p>&#x8BBE;&#x8BA1;&#x4E00;&#x4E2A;2&#x8DEF;&#x7EC4;&#x76F8;&#x8054;Cache&#xFF0C;&#x5C55;&#x793A;&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x5982;&#x4F55;&#x9884;&#x9632;&#x5E38;&#x89C1;&#x9519;&#x8BEF;&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x7D22;&#x5F15;&#x4F4D;&#x5BBD;&#x7531;Cache&#x5927;&#x5C0F;&#x81EA;&#x52A8;&#x63A8;&#x5BFC;</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">CacheSize</span> = 16384  <span class="hljs-comment">-- 16KB</span></span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">LineSize</span> = 64      <span class="hljs-comment">-- 64&#x5B57;&#x8282;</span></span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Ways</span> = 2</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Sets</span> = <span class="hljs-type">CacheSize</span> `<span class="hljs-type">Div</span>` (<span class="hljs-type">LineSize</span> * <span class="hljs-type">Ways</span>)</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">IndexBits</span> = <span class="hljs-type">CLog</span> 2 <span class="hljs-type">Sets</span></span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">OffsetBits</span> = <span class="hljs-type">CLog</span> 2 <span class="hljs-type">LineSize</span></span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">TagBits</span> = 32 - <span class="hljs-type">IndexBits</span> - <span class="hljs-type">OffsetBits</span></span>

<span class="hljs-comment">-- &#x5730;&#x5740;&#x89E3;&#x7801;&#x7C7B;&#x578B;&#x5B89;&#x5168;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">CacheAddr</span> = <span class="hljs-type">CacheAddr</span></span>
  { tag    :: <span class="hljs-type">BitVector</span> <span class="hljs-type">TagBits</span>
  , index  :: <span class="hljs-type">BitVector</span> <span class="hljs-type">IndexBits</span>
  , offset :: <span class="hljs-type">BitVector</span> <span class="hljs-type">OffsetBits</span>
  }
</code></pre>
<p>&#x8FD9;&#x79CD;&#x8BBE;&#x8BA1;&#x786E;&#x4FDD;&#xFF1A;</p>
<ul>
<li>&#x4FEE;&#x6539;Cache&#x5927;&#x5C0F;&#x81EA;&#x52A8;&#x8C03;&#x6574;&#x6240;&#x6709;&#x76F8;&#x5173;&#x4F4D;&#x5BBD;</li>
<li>&#x4E0D;&#x53EF;&#x80FD;&#x51FA;&#x73B0;&#x7D22;&#x5F15;&#x8D8A;&#x754C;</li>
<li>Tag&#x6BD4;&#x8F83;&#x59CB;&#x7EC8;&#x4F7F;&#x7528;&#x6B63;&#x786E;&#x4F4D;&#x5BBD;</li>
</ul>
<h3 id="812-clash&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x6DF1;&#x5165;">8.1.2 Clash&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x6DF1;&#x5165;</h3>
<p><strong>&#x65F6;&#x949F;&#x57DF;&#x7C7B;&#x578B;&#x53C2;&#x6570;&#x5316;</strong></p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- Signal&#x7C7B;&#x578B;&#x5E26;&#x6709;&#x65F6;&#x949F;&#x57DF;&#x53C2;&#x6570;</span>
<span class="hljs-type">Signal</span> (dom :: <span class="hljs-type">Domain</span>) a

<span class="hljs-comment">-- &#x4E0D;&#x540C;&#x65F6;&#x949F;&#x57DF;&#x7684;&#x4FE1;&#x53F7;&#x4E0D;&#x80FD;&#x76F4;&#x63A5;&#x8FDE;&#x63A5;</span>
<span class="hljs-comment">-- &#x5FC5;&#x987B;&#x901A;&#x8FC7;&#x663E;&#x5F0F;&#x7684;&#x540C;&#x6B65;&#x539F;&#x8BED;</span>
</code></pre>
<p><strong>Domain&#x7C7B;&#x578B;&#x7684;&#x5B8C;&#x6574;&#x5B9A;&#x4E49;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">Domain</span> = <span class="hljs-type">Dom</span> </span>
  { domName      :: <span class="hljs-type">Symbol</span>           <span class="hljs-comment">-- &#x57DF;&#x540D;&#x79F0;</span>
  , clkPeriod    :: <span class="hljs-type">Nat</span>              <span class="hljs-comment">-- &#x65F6;&#x949F;&#x5468;&#x671F;(ps)</span>
  , activeEdge   :: <span class="hljs-type">ActiveEdge</span>       <span class="hljs-comment">-- Rising/Falling</span>
  , resetKind    :: <span class="hljs-type">ResetKind</span>        <span class="hljs-comment">-- Asynchronous/Synchronous</span>
  , initBehavior :: <span class="hljs-type">InitBehavior</span>     <span class="hljs-comment">-- Unknown/Defined</span>
  , resetPolarity:: <span class="hljs-type">ResetPolarity</span>    <span class="hljs-comment">-- ActiveHigh/ActiveLow</span>
  }

<span class="hljs-comment">-- &#x9884;&#x5B9A;&#x4E49;&#x5E38;&#x7528;&#x65F6;&#x949F;&#x57DF;</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">System</span> = <span class="hljs-type">Dom</span> &quot;<span class="hljs-type">System</span>&quot; 10000 <span class="hljs-type">Rising</span> <span class="hljs-type">Asynchronous</span> <span class="hljs-type">Defined</span> <span class="hljs-type">ActiveHigh</span></span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Fast</span>   = <span class="hljs-type">Dom</span> &quot;<span class="hljs-type">Fast</span>&quot; 5000 <span class="hljs-type">Rising</span> <span class="hljs-type">Synchronous</span> <span class="hljs-type">Defined</span> <span class="hljs-type">ActiveLow</span></span>
</code></pre>
<p><strong>&#x9AD8;&#x7EA7;&#x7C7B;&#x578B;&#x7279;&#x6027;&#x5728;&#x786C;&#x4EF6;&#x8BBE;&#x8BA1;&#x4E2D;&#x7684;&#x5E94;&#x7528;</strong>&#xFF1A;</p>
<ol>
<li><p><strong>Phantom&#x7C7B;&#x578B;&#x9632;&#x6B62;&#x534F;&#x8BAE;&#x9519;&#x8BEF;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- Master&#x548C;Slave&#x7AEF;&#x53E3;&#x4E0D;&#x80FD;&#x8BEF;&#x8FDE;</span>
<span class="hljs-class"><span class="hljs-keyword">newtype</span> <span class="hljs-type">AXIStream</span> (<span class="hljs-title">role</span> :: <span class="hljs-type">Role</span>) a = <span class="hljs-type">AXIStream</span> </span>
  { tdata  :: <span class="hljs-type">Signal</span> dom a
  , tvalid :: <span class="hljs-type">Signal</span> dom <span class="hljs-type">Bool</span>
  , tready :: <span class="hljs-type">Signal</span> dom <span class="hljs-type">Bool</span>
  }

<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">Role</span> = <span class="hljs-type">Master</span> | <span class="hljs-type">Slave</span></span>

<span class="hljs-comment">-- &#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x5F3A;&#x5236;&#x6B63;&#x786E;&#x8FDE;&#x63A5;</span>
<span class="hljs-title">connect</span> :: <span class="hljs-type">AXIStream</span> &apos;<span class="hljs-type">Master</span> a -&gt; <span class="hljs-type">AXIStream</span> &apos;<span class="hljs-type">Slave</span> a -&gt; ()
</code></pre>
</li>
<li><p><strong>&#x7C7B;&#x578B;&#x65CF;(Type Families)&#x5B9E;&#x73B0;&#x534F;&#x8BAE;&#x53D8;&#x4F53;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-keyword">family</span> <span class="hljs-type">ProtocolWidth</span> (<span class="hljs-title">p</span> :: <span class="hljs-type">Protocol</span>) :: <span class="hljs-type">Nat</span> where</span>
  <span class="hljs-type">ProtocolWidth</span> &apos;<span class="hljs-type">AXI4</span>     = <span class="hljs-number">512</span>
  <span class="hljs-type">ProtocolWidth</span> &apos;<span class="hljs-type">AXI4Lite</span> = <span class="hljs-number">32</span>
  <span class="hljs-type">ProtocolWidth</span> &apos;<span class="hljs-type">AHB</span>      = <span class="hljs-number">64</span>
</code></pre>
</li>
<li><p><strong>GADT&#x786E;&#x4FDD;&#x72B6;&#x6001;&#x673A;&#x6B63;&#x786E;&#x6027;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">State</span> s where</span>
  <span class="hljs-type">Idle</span>    :: <span class="hljs-type">State</span> &apos;<span class="hljs-type">Idle</span>
  <span class="hljs-type">Active</span>  :: <span class="hljs-type">State</span> &apos;<span class="hljs-type">Active</span>
  <span class="hljs-type">Done</span>    :: <span class="hljs-type">State</span> &apos;<span class="hljs-type">Done</span>

<span class="hljs-comment">-- &#x53EA;&#x6709;Active&#x72B6;&#x6001;&#x624D;&#x80FD;&#x8F6C;&#x5230;Done</span>
<span class="hljs-title">finish</span> :: <span class="hljs-type">State</span> &apos;<span class="hljs-type">Active</span> -&gt; <span class="hljs-type">State</span> &apos;<span class="hljs-type">Done</span>
<span class="hljs-title">finish</span> <span class="hljs-type">Active</span> = <span class="hljs-type">Done</span>
</code></pre>
</li>
</ol>
<p><strong>&#x8D44;&#x6E90;&#x4F7F;&#x7528;&#x4F30;&#x7B97;</strong>&#xFF1A;</p>
<ul>
<li>&#x7C7B;&#x578B;&#x63A8;&#x5BFC;&#x96F6;&#x5F00;&#x9500;&#xFF1A;&#x7F16;&#x8BD1;&#x540E;&#x751F;&#x6210;&#x6807;&#x51C6;Verilog</li>
<li>&#x5178;&#x578B;RISC-V&#x89E3;&#x7801;&#x5668;&#xFF1A;~500 LUTs (Zynq UltraScale+)</li>
<li>&#x76F8;&#x6BD4;&#x624B;&#x5199;Verilog&#x51CF;&#x5C11;30%&#x4EE3;&#x7801;&#x91CF;</li>
<li>&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x68C0;&#x67E5;&#x5728;&#x7F16;&#x8BD1;&#x65F6;&#x5B8C;&#x6210;&#xFF0C;&#x4E0D;&#x5F71;&#x54CD;&#x7EFC;&#x5408;&#x7ED3;&#x679C;</li>
</ul>
<p><strong>&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x5E26;&#x6765;&#x7684;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;</strong>&#xFF1A;</p>
<ol>
<li><p><strong>Builder&#x6A21;&#x5F0F;&#x6784;&#x5EFA;&#x590D;&#x6742;&#x914D;&#x7F6E;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-title">fifoConfig</span> = defaultConfig
  &amp; depth     .~ <span class="hljs-number">512</span>
  &amp; almostFull .~ <span class="hljs-number">480</span>
  &amp; dataWidth .~ <span class="hljs-number">64</span>
</code></pre>
</li>
<li><p><strong>Witness&#x7C7B;&#x578B;&#x8BC1;&#x660E;&#x786C;&#x4EF6;&#x5C5E;&#x6027;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x8BC1;&#x660E;FIFO&#x6DF1;&#x5EA6;&#x662F;2&#x7684;&#x5E42;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">PowerOfTwo</span> (<span class="hljs-title">n</span> :: <span class="hljs-type">Nat</span>) where</span>
  <span class="hljs-type">PowZero</span> :: <span class="hljs-type">PowerOfTwo</span> <span class="hljs-number">1</span>
  <span class="hljs-type">PowSucc</span> :: <span class="hljs-type">PowerOfTwo</span> n -&gt; <span class="hljs-type">PowerOfTwo</span> (<span class="hljs-number">2</span> * n)
</code></pre>
</li>
</ol>
<h3 id="813-&#x5B9E;&#x6218;&#x6848;&#x4F8B;&#xFF1A;axi-stream&#x534F;&#x8BAE;&#x7C7B;&#x578B;&#x5EFA;&#x6A21;">8.1.3 &#x5B9E;&#x6218;&#x6848;&#x4F8B;&#xFF1A;AXI-Stream&#x534F;&#x8BAE;&#x7C7B;&#x578B;&#x5EFA;&#x6A21;</h3>
<p><strong>&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x62C6;&#x89E3;</strong>&#xFF1A;</p>
<ol>
<li><p><strong>&#x534F;&#x8BAE;&#x4FE1;&#x53F7;&#x5EFA;&#x6A21;</strong>&#xFF1A;</p>
<ul>
<li>TDATA&#x3001;TVALID&#x3001;TREADY&#x7B49;&#x4FE1;&#x53F7;&#x5C01;&#x88C5;&#x4E3A;&#x8BB0;&#x5F55;&#x7C7B;&#x578B;</li>
<li>&#x4F7F;&#x7528;phantom&#x7C7B;&#x578B;&#x53C2;&#x6570;&#x6807;&#x8BB0;&#x4E3B;&#x4ECE;&#x7AEF;</li>
<li>&#x4FA7;&#x4FE1;&#x9053;(TKEEP&#x3001;TLAST&#x7B49;)&#x4F5C;&#x4E3A;&#x53EF;&#x9009;&#x5B57;&#x6BB5;</li>
</ul>
<pre><code class="lang-haskell"><span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">AXIStreamM2S</span> (<span class="hljs-title">dataWidth</span> :: <span class="hljs-type">Nat</span>) (<span class="hljs-title">userWidth</span> :: <span class="hljs-type">Nat</span>) = <span class="hljs-type">AXIStreamM2S</span></span>
  { _tdata  :: <span class="hljs-type">BitVector</span> dataWidth
  , _tkeep  :: <span class="hljs-type">BitVector</span> (dataWidth `<span class="hljs-type">Div</span>` <span class="hljs-number">8</span>)
  , _tlast  :: <span class="hljs-type">Bool</span>
  , _tuser  :: <span class="hljs-type">BitVector</span> userWidth
  , _tvalid :: <span class="hljs-type">Bool</span>
  }

<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">AXIStreamS2M</span> = <span class="hljs-type">AXIStreamS2M</span> { <span class="hljs-title">_tready</span> :: <span class="hljs-type">Bool</span> }</span>
</code></pre>
</li>
<li><p><strong>&#x63E1;&#x624B;&#x903B;&#x8F91;&#x7C7B;&#x578B;&#x5316;</strong>&#xFF1A;</p>
<ul>
<li>Valid-Ready&#x63E1;&#x624B;&#x4F5C;&#x4E3A;&#x7C7B;&#x578B;&#x7C7B;(typeclass)</li>
<li>&#x81EA;&#x52A8;&#x6D3E;&#x751F;&#x6B63;&#x786E;&#x7684;&#x7EC4;&#x5408;&#x903B;&#x8F91;</li>
<li>&#x6B7B;&#x9501;&#x9884;&#x9632;&#x901A;&#x8FC7;&#x7C7B;&#x578B;&#x7EA6;&#x675F;</li>
</ul>
<pre><code class="lang-haskell"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">Protocol</span> p <span class="hljs-keyword">where</span></span>
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Master</span> p :: *</span>
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Slave</span> p  :: *</span>

  <span class="hljs-comment">-- &#x63E1;&#x624B;&#x89C4;&#x5219;&#x7F16;&#x7801;&#x4E3A;&#x7C7B;&#x578B;</span>
  handshake :: <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Master</span> p) 
            -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Slave</span> p) 
            -&gt; <span class="hljs-type">Signal</span> dom <span class="hljs-type">Bool</span>
<span class="hljs-class">
<span class="hljs-keyword">instance</span> <span class="hljs-type">Protocol</span> (<span class="hljs-type">AXIStream</span> <span class="hljs-title">n</span> <span class="hljs-title">u</span>) <span class="hljs-keyword">where</span></span>
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Master</span> (<span class="hljs-type">AXIStream</span> <span class="hljs-title">n</span> <span class="hljs-title">u</span>) = <span class="hljs-type">AXIStreamM2S</span> n u</span>
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Slave</span>  (<span class="hljs-type">AXIStream</span> <span class="hljs-title">n</span> <span class="hljs-title">u</span>) = <span class="hljs-type">AXIStreamS2M</span></span>

  handshake m2s s2m = _tvalid &lt;$&gt; m2s .&amp;&amp;. _tready &lt;$&gt; s2m
</code></pre>
</li>
<li><p><strong>&#x80CC;&#x538B;&#x5904;&#x7406;</strong>&#xFF1A;</p>
<ul>
<li>&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x786E;&#x4FDD;TREADY&#x4FE1;&#x53F7;&#x6B63;&#x786E;&#x4F20;&#x64AD;</li>
<li>&#x9632;&#x6B62;&#x6570;&#x636E;&#x4E22;&#x5931;&#x7684;&#x7F16;&#x8BD1;&#x65F6;&#x4FDD;&#x8BC1;</li>
<li>Skid buffer&#x81EA;&#x52A8;&#x63D2;&#x5165;</li>
</ul>
</li>
</ol>
<p><strong>&#x5B8C;&#x6574;&#x7684;&#x7C7B;&#x578B;&#x5B89;&#x5168;AXI-Stream FIFO&#x5B9E;&#x73B0;&#x601D;&#x8DEF;</strong>&#xFF1A;</p>
<ol>
<li><p><strong>&#x63A5;&#x53E3;&#x5B9A;&#x4E49;</strong>&#xFF1A;</p>
<ul>
<li>&#x53C2;&#x6570;&#x5316;&#x6DF1;&#x5EA6;&#x3001;&#x5BBD;&#x5EA6;&#x3001;&#x662F;&#x5426;&#x9700;&#x8981;TLAST</li>
<li>&#x7F16;&#x8BD1;&#x65F6;&#x8BA1;&#x7B97;&#x5730;&#x5740;&#x4F4D;&#x5BBD;</li>
</ul>
</li>
<li><p><strong>&#x5185;&#x90E8;&#x72B6;&#x6001;&#x7BA1;&#x7406;</strong>&#xFF1A;</p>
<ul>
<li>&#x8BFB;&#x5199;&#x6307;&#x9488;&#x4F7F;&#x7528;&#x6A21;&#x8FD0;&#x7B97;&#x7C7B;&#x578B;</li>
<li>&#x7A7A;&#x6EE1;&#x6807;&#x5FD7;&#x7CBE;&#x786E;&#x8BA1;&#x7B97;</li>
<li>&#x51E0;&#x4E4E;&#x6EE1;/&#x51E0;&#x4E4E;&#x7A7A;&#x9608;&#x503C;&#x7C7B;&#x578B;&#x68C0;&#x67E5;</li>
</ul>
</li>
<li><p><strong>&#x4F18;&#x5316;&#x7279;&#x6027;</strong>&#xFF1A;</p>
<ul>
<li>First-Word-Fall-Through&#x6A21;&#x5F0F;</li>
<li>Store-and-Forward&#x9009;&#x9879;</li>
<li>&#x53EF;&#x9009;&#x7684;ECC&#x4FDD;&#x62A4;</li>
</ul>
</li>
</ol>
<p><strong>&#x5B9E;&#x9645;&#x5E94;&#x7528;&#xFF1A;&#x89C6;&#x9891;&#x6D41;&#x5904;&#x7406;&#x7BA1;&#x9053;</strong></p>
<p>&#x8BBE;&#x8BA1;&#x4E00;&#x4E2A;4K@60fps&#x89C6;&#x9891;&#x5904;&#x7406;&#x6D41;&#x6C34;&#x7EBF;&#xFF1A;</p>
<ol>
<li><p><strong>&#x50CF;&#x7D20;&#x6D41;&#x7C7B;&#x578B;&#x5B9A;&#x4E49;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">PixelData</span> = <span class="hljs-type">BitVector</span> 30  <span class="hljs-comment">-- RGB 10-bit each</span></span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">VideoStream</span> = <span class="hljs-type">AXIStream</span> 8 4  <span class="hljs-comment">-- 8 pixels/cycle</span></span>
</code></pre>
</li>
<li><p><strong>&#x5E27;&#x540C;&#x6B65;&#x4FE1;&#x53F7;&#x7F16;&#x7801;</strong>&#xFF1A;</p>
<ul>
<li>TUSER&#x7F16;&#x7801;SOF(Start-of-Frame)</li>
<li>TLAST&#x6807;&#x8BB0;&#x884C;&#x5C3E;</li>
<li>&#x7C7B;&#x578B;&#x4FDD;&#x8BC1;&#x5E27;&#x5B8C;&#x6574;&#x6027;</li>
</ul>
</li>
<li><p><strong>&#x80CC;&#x538B;&#x5904;&#x7406;&#x7B56;&#x7565;</strong>&#xFF1A;</p>
<ul>
<li>&#x884C;&#x7F13;&#x51B2;&#x81EA;&#x52A8;&#x7BA1;&#x7406;</li>
<li>&#x5782;&#x76F4;&#x6D88;&#x9690;&#x671F;&#x95F4;&#x91CA;&#x653E;&#x538B;&#x529B;</li>
<li>&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x9632;&#x6B62;&#x5E27;&#x6495;&#x88C2;</li>
</ul>
</li>
</ol>
<p><strong>&#x8D44;&#x6E90;&#x4F7F;&#x7528;&#xFF08;Zynq UltraScale+ XCZU7EV&#xFF09;</strong>&#xFF1A;</p>
<ul>
<li>AXI-Stream FIFO (512&#x6DF1;&#xD7;64&#x4F4D;)&#xFF1A;<ul>
<li>LUTs: 180</li>
<li>FFs: 320  </li>
<li>BRAM: 1 (36Kb)</li>
</ul>
</li>
<li>&#x65F6;&#x5E8F;&#xFF1A;350MHz @ -2&#x901F;&#x5EA6;&#x7B49;&#x7EA7;</li>
</ul>
<h2 id="82-&#x9AD8;&#x9636;&#x51FD;&#x6570;&#x4E0E;&#x786C;&#x4EF6;&#x62BD;&#x8C61;">8.2 &#x9AD8;&#x9636;&#x51FD;&#x6570;&#x4E0E;&#x786C;&#x4EF6;&#x62BD;&#x8C61;</h2>
<h3 id="821-&#x51FD;&#x6570;&#x4F5C;&#x4E3A;&#x786C;&#x4EF6;&#x6A21;&#x5757;">8.2.1 &#x51FD;&#x6570;&#x4F5C;&#x4E3A;&#x786C;&#x4EF6;&#x6A21;&#x5757;</h3>
<p>&#x5728;Clash&#x4E2D;&#xFF0C;&#x51FD;&#x6570;&#x76F4;&#x63A5;&#x5BF9;&#x5E94;&#x786C;&#x4EF6;&#x6A21;&#x5757;&#xFF0C;&#x9AD8;&#x9636;&#x51FD;&#x6570;&#x5219;&#x5B9E;&#x73B0;&#x4E86;&#x786C;&#x4EF6;&#x6A21;&#x5757;&#x7684;&#x53C2;&#x6570;&#x5316;&#x548C;&#x7EC4;&#x5408;&#x3002;</p>
<p><strong>&#x6838;&#x5FC3;&#x6A21;&#x5F0F;&#xFF1A;map&#x3001;fold&#x3001;scan&#x7684;&#x786C;&#x4EF6;&#x8BED;&#x4E49;</strong></p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- map&#x5BF9;&#x5E94;&#x5E76;&#x884C;&#x786C;&#x4EF6;&#x7ED3;&#x6784;</span>
<span class="hljs-title">mapV</span> :: (a -&gt; b) -&gt; <span class="hljs-type">Vec</span> n a -&gt; <span class="hljs-type">Vec</span> n b

<span class="hljs-comment">-- fold&#x5BF9;&#x5E94;&#x5F52;&#x7EA6;&#x6811;&#x7ED3;&#x6784;  </span>
<span class="hljs-title">foldV</span> :: (a -&gt; a -&gt; a) -&gt; <span class="hljs-type">Vec</span> n a -&gt; a

<span class="hljs-comment">-- scan&#x5BF9;&#x5E94;&#x6D41;&#x6C34;&#x7EBF;&#x7D2F;&#x52A0;&#x5668;</span>
<span class="hljs-title">scanV</span> :: (a -&gt; b -&gt; a) -&gt; a -&gt; <span class="hljs-type">Vec</span> n b -&gt; <span class="hljs-type">Vec</span> n a
</code></pre>
<p><strong>&#x6DF1;&#x5165;&#x7406;&#x89E3;&#x786C;&#x4EF6;&#x6620;&#x5C04;&#x89C4;&#x5219;</strong>&#xFF1A;</p>
<ol>
<li><p><strong>map&#x7684;&#x5E76;&#x884C;&#x5C55;&#x5F00;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- 8&#x4E2A;&#x5E76;&#x884C;&#x4E58;&#x6CD5;&#x5668;</span>
<span class="hljs-title">mulBy2</span> :: <span class="hljs-type">Vec</span> <span class="hljs-number">8</span> (<span class="hljs-type">Signed</span> <span class="hljs-number">16</span>) -&gt; <span class="hljs-type">Vec</span> <span class="hljs-number">8</span> (<span class="hljs-type">Signed</span> <span class="hljs-number">16</span>)
<span class="hljs-title">mulBy2</span> = mapV (*<span class="hljs-number">2</span>)

<span class="hljs-comment">-- &#x751F;&#x6210;8&#x4E2A;&#x72EC;&#x7ACB;&#x7684;&#x4E58;&#x6CD5;&#x5355;&#x5143;&#xFF0C;&#x65E0;&#x5171;&#x4EAB;</span>
<span class="hljs-comment">-- &#x6BCF;&#x4E2A;&#x5360;&#x7528;1&#x4E2A;DSP48E2</span>
</code></pre>
</li>
<li><p><strong>fold&#x7684;&#x6811;&#x5F62;&#x5F52;&#x7EA6;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x751F;&#x6210;3&#x7EA7;&#x52A0;&#x6CD5;&#x6811;(log2(8))</span>
<span class="hljs-title">sumTree</span> :: <span class="hljs-type">Vec</span> <span class="hljs-number">8</span> (<span class="hljs-type">Signed</span> <span class="hljs-number">16</span>) -&gt; <span class="hljs-type">Signed</span> <span class="hljs-number">16</span>
<span class="hljs-title">sumTree</span> = fold (+)

<span class="hljs-comment">-- &#x786C;&#x4EF6;&#x7ED3;&#x6784;&#xFF1A;</span>
<span class="hljs-comment">-- Level 1: 4&#x4E2A;&#x52A0;&#x6CD5;&#x5668;</span>
<span class="hljs-comment">-- Level 2: 2&#x4E2A;&#x52A0;&#x6CD5;&#x5668;  </span>
<span class="hljs-comment">-- Level 3: 1&#x4E2A;&#x52A0;&#x6CD5;&#x5668;</span>
<span class="hljs-comment">-- &#x603B;&#x5EF6;&#x8FDF;&#xFF1A;3&#x4E2A;&#x52A0;&#x6CD5;&#x5668;&#x5EF6;&#x8FDF;</span>
</code></pre>
</li>
<li><p><strong>scan&#x7684;&#x6D41;&#x6C34;&#x7EBF;&#x7ED3;&#x6784;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x7D2F;&#x52A0;&#x5668;&#x94FE;&#xFF0C;&#x6BCF;&#x7EA7;&#x4E00;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;</span>
<span class="hljs-title">runningSum</span> :: <span class="hljs-type">Vec</span> <span class="hljs-number">8</span> (<span class="hljs-type">Signed</span> <span class="hljs-number">16</span>) -&gt; <span class="hljs-type">Vec</span> <span class="hljs-number">8</span> (<span class="hljs-type">Signed</span> <span class="hljs-number">16</span>)
<span class="hljs-title">runningSum</span> = scanl (+) <span class="hljs-number">0</span>

<span class="hljs-comment">-- &#x751F;&#x6210;8&#x7EA7;&#x6D41;&#x6C34;&#x7EBF;&#x7D2F;&#x52A0;&#x5668;</span>
<span class="hljs-comment">-- &#x5EF6;&#x8FDF;&#xFF1A;8&#x5468;&#x671F;&#xFF0C;&#x541E;&#x5410;&#x91CF;&#xFF1A;1&#x7ED3;&#x679C;/&#x5468;&#x671F;</span>
</code></pre>
</li>
</ol>
<p><strong>&#x9AD8;&#x9636;&#x51FD;&#x6570;&#x7EC4;&#x5408;&#x7684;&#x5A01;&#x529B;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x6ED1;&#x52A8;&#x7A97;&#x53E3;&#x5B9E;&#x73B0;</span>
<span class="hljs-title">windows</span> :: <span class="hljs-type">KnownNat</span> n =&gt; <span class="hljs-type">SNat</span> m -&gt; <span class="hljs-type">Vec</span> (n + m - <span class="hljs-number">1</span>) a -&gt; <span class="hljs-type">Vec</span> n (<span class="hljs-type">Vec</span> m a)
<span class="hljs-title">windows</span> size = mapV (takeLast size) . mapV (takeFirst size) . tails

<span class="hljs-comment">-- 2D&#x5377;&#x79EF;&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x7EC4;&#x5408;</span>
<span class="hljs-title">conv2d</span> :: (<span class="hljs-type">KnownNat</span> h, <span class="hljs-type">KnownNat</span> w) 
       =&gt; <span class="hljs-type">Vec</span> kh (<span class="hljs-type">Vec</span> kw <span class="hljs-type">Int8</span>)           <span class="hljs-comment">-- &#x5377;&#x79EF;&#x6838;</span>
       -&gt; <span class="hljs-type">Vec</span> (h+kh<span class="hljs-number">-1</span>) (<span class="hljs-type">Vec</span> (w+kw<span class="hljs-number">-1</span>) <span class="hljs-type">Int8</span>) <span class="hljs-comment">-- &#x8F93;&#x5165;</span>
       -&gt; <span class="hljs-type">Vec</span> h (<span class="hljs-type">Vec</span> w <span class="hljs-type">Int16</span>)            <span class="hljs-comment">-- &#x8F93;&#x51FA;</span>
<span class="hljs-title">conv2d</span> kernel = mapV (mapV sum . mapV (zipWith dotProduct kernel)) . windows2d
</code></pre>
<p><strong>&#x5E94;&#x7528;&#x5B9E;&#x4F8B;&#xFF1A;&#x5377;&#x79EF;&#x795E;&#x7ECF;&#x7F51;&#x7EDC;&#x52A0;&#x901F;&#x5668;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;</strong></p>
<ol>
<li><p><strong>&#x5377;&#x79EF;&#x6838;&#x62BD;&#x8C61;</strong>&#xFF1A;</p>
<ul>
<li>&#x5C06;&#x5377;&#x79EF;&#x64CD;&#x4F5C;&#x8868;&#x793A;&#x4E3A;&#x9AD8;&#x9636;&#x51FD;&#x6570;</li>
<li>&#x81EA;&#x52A8;&#x5C55;&#x5F00;&#x4E3A;&#x5E76;&#x884C;&#x4E58;&#x52A0;&#x6811;</li>
<li>&#x652F;&#x6301;&#x53EF;&#x53D8;&#x6B65;&#x957F;&#x548C;&#x586B;&#x5145;</li>
</ul>
<pre><code class="lang-haskell"><span class="hljs-comment">-- 3x3&#x5377;&#x79EF;&#xFF0C;&#x6B65;&#x957F;1&#xFF0C;&#x586B;&#x5145;1</span>
<span class="hljs-title">conv3x3</span> :: <span class="hljs-type">Num</span> a =&gt; <span class="hljs-type">Vec</span> <span class="hljs-number">3</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">3</span> a) -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> a)) 
       -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> a))
<span class="hljs-title">conv3x3</span> kernel = fmap (conv2d kernel . pad <span class="hljs-number">1</span> <span class="hljs-number">0</span>)
</code></pre>
</li>
<li><p><strong>&#x7279;&#x5F81;&#x56FE;&#x5904;&#x7406;</strong>&#xFF1A;</p>
<ul>
<li>&#x4F7F;&#x7528;map2&#x5B9E;&#x73B0;&#x9010;&#x5143;&#x7D20;&#x64CD;&#x4F5C;(ReLU&#x7B49;)</li>
<li>fold&#x5B9E;&#x73B0;&#x6C60;&#x5316;&#x5C42;</li>
<li>&#x6279;&#x5F52;&#x4E00;&#x5316;&#x7684;&#x6D41;&#x5F0F;&#x8BA1;&#x7B97;</li>
</ul>
<pre><code class="lang-haskell"><span class="hljs-comment">-- ReLU&#x6FC0;&#x6D3B;&#x51FD;&#x6570;</span>
<span class="hljs-title">relu</span> :: (<span class="hljs-type">Ord</span> a, <span class="hljs-type">Num</span> a) =&gt; a -&gt; a
<span class="hljs-title">relu</span> = max <span class="hljs-number">0</span>

<span class="hljs-comment">-- 2x2&#x6700;&#x5927;&#x6C60;&#x5316;</span>
<span class="hljs-title">maxPool2x2</span> :: (<span class="hljs-type">Ord</span> a, <span class="hljs-type">KnownNat</span> n) =&gt; <span class="hljs-type">Vec</span> (<span class="hljs-number">2</span>*n) (<span class="hljs-type">Vec</span> (<span class="hljs-number">2</span>*n) a) -&gt; <span class="hljs-type">Vec</span> n (<span class="hljs-type">Vec</span> n a)
<span class="hljs-title">maxPool2x2</span> = mapV (mapV maximum . unconcatV d2) . unconcatV d2
  <span class="hljs-keyword">where</span> d2 = <span class="hljs-type">SNat</span> @<span class="hljs-number">2</span>
</code></pre>
</li>
<li><p><strong>&#x6D41;&#x6C34;&#x7EBF;&#x81EA;&#x52A8;&#x751F;&#x6210;</strong>&#xFF1A;</p>
<ul>
<li>&#x901A;&#x8FC7;&#x51FD;&#x6570;&#x7EC4;&#x5408;&#x81EA;&#x52A8;&#x63A8;&#x5BFC;&#x6D41;&#x6C34;&#x7EBF;&#x6DF1;&#x5EA6;</li>
<li>&#x5BC4;&#x5B58;&#x5668;&#x81EA;&#x52A8;&#x63D2;&#x5165;&#x4F18;&#x5316;&#x65F6;&#x5E8F;</li>
<li>&#x652F;&#x6301;&#x7EC6;&#x7C92;&#x5EA6;&#x6D41;&#x6C34;&#x7EBF;&#x63A7;&#x5236;</li>
</ul>
</li>
</ol>
<p><strong>&#x6DF1;&#x5EA6;&#x5B66;&#x4E60;&#x63A8;&#x7406;&#x5F15;&#x64CE;&#x5B9E;&#x4F8B;&#xFF1A;MobileNet&#x52A0;&#x901F;&#x5668;</strong></p>
<p>&#x8BBE;&#x8BA1;&#x4E00;&#x4E2A;&#x6DF1;&#x5EA6;&#x53EF;&#x5206;&#x79BB;&#x5377;&#x79EF;&#x52A0;&#x901F;&#x5668;&#xFF1A;</p>
<ol>
<li><p><strong>&#x6DF1;&#x5EA6;&#x5377;&#x79EF;(Depthwise)</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x6BCF;&#x4E2A;&#x901A;&#x9053;&#x72EC;&#x7ACB;3x3&#x5377;&#x79EF;</span>
<span class="hljs-title">depthwiseConv</span> :: <span class="hljs-type">Vec</span> <span class="hljs-number">32</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">3</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">3</span> <span class="hljs-type">Int8</span>))  <span class="hljs-comment">-- 32&#x4E2A;3x3&#x6838;</span>
              -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">224</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">224</span> <span class="hljs-type">Int8</span>)))
              -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">224</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">224</span> <span class="hljs-type">Int16</span>)))
</code></pre>
</li>
<li><p><strong>&#x9010;&#x70B9;&#x5377;&#x79EF;(Pointwise)</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- 1x1&#x5377;&#x79EF;&#xFF0C;&#x6539;&#x53D8;&#x901A;&#x9053;&#x6570;</span>
<span class="hljs-title">pointwiseConv</span> :: <span class="hljs-type">Vec</span> <span class="hljs-number">64</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> <span class="hljs-type">Int8</span>)  <span class="hljs-comment">-- 64&#x4E2A;&#x8F93;&#x51FA;&#x901A;&#x9053;</span>
              -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">224</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">224</span> <span class="hljs-type">Int16</span>)))
              -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Vec</span> <span class="hljs-number">64</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">224</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">224</span> <span class="hljs-type">Int16</span>)))
</code></pre>
</li>
<li><p><strong>&#x8D44;&#x6E90;&#x4F18;&#x5316;&#x7B56;&#x7565;</strong>&#xFF1A;</p>
<ul>
<li>&#x901A;&#x9053;&#x5E76;&#x884C;&#x5EA6;&#x53EF;&#x914D;&#x7F6E;(1/2/4/8)</li>
<li>&#x6743;&#x91CD;&#x91CF;&#x5316;&#x5230;INT8</li>
<li>&#x6FC0;&#x6D3B;&#x503C;INT16&#x9632;&#x6B62;&#x6EA2;&#x51FA;</li>
</ul>
</li>
</ol>
<p><strong>&#x6027;&#x80FD;&#x4E0E;&#x8D44;&#x6E90;&#x5206;&#x6790;(ZU9EG)</strong>&#xFF1A;</p>
<ul>
<li>32&#x901A;&#x9053;&#x5E76;&#x884C;&#xFF1A;<ul>
<li>DSP48E2: 288 (32&#xD7;9 for 3&#xD7;3)</li>
<li>&#x541E;&#x5410;&#x91CF;: 1.8 TOPS @ 200MHz</li>
<li>&#x529F;&#x8017;: ~15W</li>
</ul>
</li>
<li>&#x4F18;&#x5316;&#x540E;&#x7684;&#x8D44;&#x6E90;&#x5171;&#x4EAB;&#xFF1A;<ul>
<li>DSP48E2: 72 (&#x65F6;&#x5206;&#x590D;&#x7528;)</li>
<li>&#x541E;&#x5410;&#x91CF;: 450 GOPS @ 200MHz</li>
<li>&#x529F;&#x8017;: ~8W</li>
</ul>
</li>
</ul>
<h3 id="822-&#x786C;&#x4EF6;&#x751F;&#x6210;&#x5668;&#x6A21;&#x5F0F;">8.2.2 &#x786C;&#x4EF6;&#x751F;&#x6210;&#x5668;&#x6A21;&#x5F0F;</h3>
<p><strong>&#x53C2;&#x6570;&#x5316;&#x6A21;&#x5757;&#x751F;&#x6210;</strong></p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x751F;&#x6210;&#x4EFB;&#x610F;&#x5BBD;&#x5EA6;&#x7684;&#x8109;&#x52A8;&#x9635;&#x5217;</span>
<span class="hljs-title">systolicArray</span> :: <span class="hljs-type">KnownNat</span> n =&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Vec</span> n <span class="hljs-type">Word8</span>) 
              -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Vec</span> n <span class="hljs-type">Word8</span>)
              -&gt; <span class="hljs-type">Signal</span> dom <span class="hljs-type">Word32</span>
</code></pre>
<p><strong>&#x8D44;&#x6E90;&#x4F7F;&#x7528;&#x5206;&#x6790;</strong>&#xFF1A;</p>
<ul>
<li>8x8&#x8109;&#x52A8;&#x9635;&#x5217;&#xFF1A;64&#x4E2A;DSP48E2 (&#x7406;&#x8BBA;&#x6700;&#x4F18;)</li>
<li>&#x81EA;&#x52A8;&#x6D41;&#x6C34;&#x7EBF;&#x63D2;&#x5165;&#xFF1A;200MHz @ -1&#x901F;&#x5EA6;&#x7B49;&#x7EA7;</li>
<li>&#x76F8;&#x6BD4;HLS&#x51CF;&#x5C11;15%&#x8D44;&#x6E90;&#x4F7F;&#x7528;</li>
</ul>
<h3 id="823-&#x5B9E;&#x6218;&#x6848;&#x4F8B;&#xFF1A;&#x53EF;&#x914D;&#x7F6E;fft&#x5904;&#x7406;&#x5668;">8.2.3 &#x5B9E;&#x6218;&#x6848;&#x4F8B;&#xFF1A;&#x53EF;&#x914D;&#x7F6E;FFT&#x5904;&#x7406;&#x5668;</h3>
<p><strong>&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x62C6;&#x89E3;</strong>&#xFF1A;</p>
<ol>
<li><p><strong>Cooley-Tukey&#x7B97;&#x6CD5;&#x51FD;&#x6570;&#x5F0F;&#x8868;&#x8FBE;</strong>&#xFF1A;</p>
<ul>
<li>&#x9012;&#x5F52;&#x7ED3;&#x6784;&#x81EA;&#x7136;&#x6620;&#x5C04;&#x5230;&#x786C;&#x4EF6;</li>
<li>&#x8776;&#x5F62;&#x8FD0;&#x7B97;&#x4F5C;&#x4E3A;&#x57FA;&#x672C;&#x7EC4;&#x5408;&#x5B50;</li>
</ul>
</li>
<li><p><strong>&#x6DF7;&#x5408;&#x57FA;FFT&#x5B9E;&#x73B0;</strong>&#xFF1A;</p>
<ul>
<li>&#x57FA;-2&#x3001;&#x57FA;-4&#x6A21;&#x5757;&#x4F5C;&#x4E3A;&#x9AD8;&#x9636;&#x51FD;&#x6570;&#x53C2;&#x6570;</li>
<li>&#x7F16;&#x8BD1;&#x65F6;&#x9009;&#x62E9;&#x6700;&#x4F18;&#x5206;&#x89E3;</li>
</ul>
</li>
<li><p><strong>&#x65CB;&#x8F6C;&#x56E0;&#x5B50;&#x4F18;&#x5316;</strong>&#xFF1A;</p>
<ul>
<li>&#x5229;&#x7528;&#x5BF9;&#x79F0;&#x6027;&#x51CF;&#x5C11;&#x5B58;&#x50A8;</li>
<li>CORDIC&#x4E0E;&#x67E5;&#x627E;&#x8868;&#x6DF7;&#x5408;&#x65B9;&#x6848;</li>
</ul>
</li>
</ol>
<h2 id="83-clash&#x7F16;&#x8BD1;&#x5668;&#x539F;&#x7406;">8.3 Clash&#x7F16;&#x8BD1;&#x5668;&#x539F;&#x7406;</h2>
<h3 id="831-&#x4ECE;haskell&#x5230;&#x786C;&#x4EF6;&#x7684;&#x8F6C;&#x6362;&#x6D41;&#x7A0B;">8.3.1 &#x4ECE;Haskell&#x5230;&#x786C;&#x4EF6;&#x7684;&#x8F6C;&#x6362;&#x6D41;&#x7A0B;</h3>
<p>Clash&#x7F16;&#x8BD1;&#x5668;&#x5C06;&#x51FD;&#x6570;&#x5F0F;&#x63CF;&#x8FF0;&#x8F6C;&#x6362;&#x4E3A;&#x53EF;&#x7EFC;&#x5408;&#x7684;HDL&#xFF0C;&#x7406;&#x89E3;&#x5176;&#x539F;&#x7406;&#x6709;&#x52A9;&#x4E8E;&#x5199;&#x51FA;&#x9AD8;&#x6548;&#x7684;&#x786C;&#x4EF6;&#x4EE3;&#x7801;&#x3002;</p>
<p><strong>&#x7F16;&#x8BD1;&#x6D41;&#x7A0B;&#x6982;&#x89C8;</strong>&#xFF1A;</p>
<ol>
<li><p><strong>Core&#x8BED;&#x8A00;&#x8F6C;&#x6362;</strong>&#xFF1A;</p>
<ul>
<li>Haskell&#x6E90;&#x7801; &#x2192; GHC Core</li>
<li>&#x7C7B;&#x578B;&#x64E6;&#x9664;&#x4E0E;&#x3BB;&#x6F14;&#x7B97;&#x7B80;&#x5316;</li>
</ul>
</li>
<li><p><strong>&#x786C;&#x4EF6;&#x6620;&#x5C04;&#x89C4;&#x5219;</strong>&#xFF1A;</p>
<ul>
<li>&#x51FD;&#x6570; &#x2192; &#x7EC4;&#x5408;&#x903B;&#x8F91;</li>
<li>&#x9012;&#x5F52; &#x2192; &#x53CD;&#x9988;&#x56DE;&#x8DEF;/&#x72B6;&#x6001;&#x673A;</li>
<li>&#x9AD8;&#x9636;&#x51FD;&#x6570; &#x2192; &#x786C;&#x4EF6;&#x751F;&#x6210;&#x5668;</li>
</ul>
</li>
<li><p><strong>&#x4F18;&#x5316;passes</strong>&#xFF1A;</p>
<ul>
<li>&#x3B2;-&#x5F52;&#x7EA6;&#xFF1A;&#x5185;&#x8054;&#x5C0F;&#x51FD;&#x6570;</li>
<li>&#x5E38;&#x91CF;&#x6298;&#x53E0;&#xFF1A;&#x7F16;&#x8BD1;&#x65F6;&#x8BA1;&#x7B97;</li>
<li>&#x8D44;&#x6E90;&#x5171;&#x4EAB;&#xFF1A;&#x8BC6;&#x522B;&#x76F8;&#x540C;&#x5B50;&#x7535;&#x8DEF;</li>
</ul>
</li>
</ol>
<h3 id="832-&#x540C;&#x6B65;&#x4E0E;&#x65F6;&#x5E8F;&#x63A8;&#x5BFC;">8.3.2 &#x540C;&#x6B65;&#x4E0E;&#x65F6;&#x5E8F;&#x63A8;&#x5BFC;</h3>
<p><strong>&#x9690;&#x5F0F;&#x5BC4;&#x5B58;&#x5668;&#x63D2;&#x5165;&#x89C4;&#x5219;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- register&#x539F;&#x8BED;&#x663E;&#x5F0F;&#x63D2;&#x5165;&#x5BC4;&#x5B58;&#x5668;</span>
<span class="hljs-title">register</span> :: <span class="hljs-type">Signal</span> dom a -&gt; <span class="hljs-type">Signal</span> dom a

<span class="hljs-comment">-- &#x6BCF;&#x4E2A;&#x9012;&#x5F52;&#x5B9A;&#x4E49;&#x81EA;&#x52A8;&#x63D2;&#x5165;&#x5BC4;&#x5B58;&#x5668;</span>
<span class="hljs-title">counter</span> = register <span class="hljs-number">0</span> (counter + <span class="hljs-number">1</span>)
</code></pre>
<p><strong>&#x65F6;&#x5E8F;&#x7EA6;&#x675F;&#x751F;&#x6210;</strong>&#xFF1A;</p>
<ul>
<li>&#x81EA;&#x52A8;&#x8BC6;&#x522B;&#x5173;&#x952E;&#x8DEF;&#x5F84;</li>
<li>&#x751F;&#x6210;SDC&#x7EA6;&#x675F;&#x6587;&#x4EF6;</li>
<li>&#x652F;&#x6301;&#x591A;&#x5468;&#x671F;&#x8DEF;&#x5F84;&#x6807;&#x6CE8;</li>
</ul>
<h3 id="833-&#x5B9E;&#x6218;&#x6848;&#x4F8B;&#xFF1A;&#x9AD8;&#x6548;&#x4E58;&#x6CD5;&#x5668;&#x751F;&#x6210;">8.3.3 &#x5B9E;&#x6218;&#x6848;&#x4F8B;&#xFF1A;&#x9AD8;&#x6548;&#x4E58;&#x6CD5;&#x5668;&#x751F;&#x6210;</h3>
<p><strong>&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x62C6;&#x89E3;</strong>&#xFF1A;</p>
<ol>
<li><p><strong>Karatsuba&#x7B97;&#x6CD5;&#x5B9E;&#x73B0;</strong>&#xFF1A;</p>
<ul>
<li>&#x9012;&#x5F52;&#x5206;&#x89E3;&#x5927;&#x4F4D;&#x5BBD;&#x4E58;&#x6CD5;</li>
<li>&#x9608;&#x503C;&#x53C2;&#x6570;&#x63A7;&#x5236;&#x9012;&#x5F52;&#x6DF1;&#x5EA6;</li>
</ul>
</li>
<li><p><strong>DSP&#x63A8;&#x5BFC;&#x4F18;&#x5316;</strong>&#xFF1A;</p>
<ul>
<li>&#x8BC6;&#x522B;&#x4E58;&#x52A0;&#x6A21;&#x5F0F;&#x6620;&#x5C04;&#x5230;DSP48</li>
<li>&#x7EA7;&#x8054;&#x63A8;&#x5BFC;&#x51CF;&#x5C11;&#x5E03;&#x7EBF;&#x5EF6;&#x8FDF;</li>
</ul>
</li>
<li><p><strong>&#x6D41;&#x6C34;&#x7EBF;&#x5E73;&#x8861;</strong>&#xFF1A;</p>
<ul>
<li>&#x81EA;&#x52A8;&#x8BA1;&#x7B97;&#x5404;&#x7EA7;&#x5EF6;&#x8FDF;</li>
<li>&#x63D2;&#x5165;&#x5E73;&#x8861;&#x5BC4;&#x5B58;&#x5668;</li>
</ul>
</li>
</ol>
<p><strong>&#x6027;&#x80FD;&#x6570;&#x636E;</strong>&#xFF1A;</p>
<ul>
<li>64&#x4F4D;&#x4E58;&#x6CD5;&#x5668;&#xFF1A;12&#x4E2A;DSP48E2</li>
<li>5&#x7EA7;&#x6D41;&#x6C34;&#x7EBF;&#xFF1A;450MHz @ -2&#x901F;&#x5EA6;&#x7B49;&#x7EA7;</li>
<li>&#x5EF6;&#x8FDF;&#xFF1A;5&#x5468;&#x671F;&#xFF0C;&#x541E;&#x5410;&#x91CF;&#xFF1A;1&#x7ED3;&#x679C;/&#x5468;&#x671F;</li>
</ul>
<h2 id="84-&#x4FE1;&#x53F7;&#x5904;&#x7406;&#x4E0E;&#x72B6;&#x6001;&#x673A;&#x5EFA;&#x6A21;">8.4 &#x4FE1;&#x53F7;&#x5904;&#x7406;&#x4E0E;&#x72B6;&#x6001;&#x673A;&#x5EFA;&#x6A21;</h2>
<h3 id="841-moore&#x4E0E;mealy&#x673A;&#x5728;clash&#x4E2D;&#x7684;&#x8868;&#x8FBE;">8.4.1 Moore&#x4E0E;Mealy&#x673A;&#x5728;Clash&#x4E2D;&#x7684;&#x8868;&#x8FBE;</h3>
<p>&#x72B6;&#x6001;&#x673A;&#x662F;&#x6570;&#x5B57;&#x8BBE;&#x8BA1;&#x7684;&#x6838;&#x5FC3;&#xFF0C;Clash&#x63D0;&#x4F9B;&#x4E86;&#x4F18;&#x96C5;&#x7684;&#x72B6;&#x6001;&#x673A;&#x5EFA;&#x6A21;&#x65B9;&#x6CD5;&#x3002;</p>
<p><strong>Moore&#x673A;&#x6A21;&#x677F;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-title">moore</span> :: (s -&gt; i -&gt; s)    <span class="hljs-comment">-- &#x72B6;&#x6001;&#x8F6C;&#x79FB;&#x51FD;&#x6570;</span>
      -&gt; (s -&gt; o)          <span class="hljs-comment">-- &#x8F93;&#x51FA;&#x51FD;&#x6570;  </span>
      -&gt; s                 <span class="hljs-comment">-- &#x521D;&#x59CB;&#x72B6;&#x6001;</span>
      -&gt; <span class="hljs-type">Signal</span> dom i -&gt; <span class="hljs-type">Signal</span> dom o
</code></pre>
<p><strong>Mealy&#x673A;&#x6A21;&#x677F;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-title">mealy</span> :: (s -&gt; i -&gt; (s, o))  <span class="hljs-comment">-- &#x7EC4;&#x5408;&#x8F6C;&#x79FB;&#x8F93;&#x51FA;&#x51FD;&#x6570;</span>
      -&gt; s                    <span class="hljs-comment">-- &#x521D;&#x59CB;&#x72B6;&#x6001;</span>
      -&gt; <span class="hljs-type">Signal</span> dom i -&gt; <span class="hljs-type">Signal</span> dom o
</code></pre>
<h3 id="842-&#x590D;&#x6742;&#x534F;&#x8BAE;&#x72B6;&#x6001;&#x673A;&#x5B9E;&#x73B0;">8.4.2 &#x590D;&#x6742;&#x534F;&#x8BAE;&#x72B6;&#x6001;&#x673A;&#x5B9E;&#x73B0;</h3>
<p><strong>&#x5E94;&#x7528;&#x5B9E;&#x4F8B;&#xFF1A;PCIe TLP&#x5904;&#x7406;&#x72B6;&#x6001;&#x673A;&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;</strong></p>
<ol>
<li><p><strong>TLP&#x7C7B;&#x578B;&#x5EFA;&#x6A21;</strong>&#xFF1A;</p>
<ul>
<li>Memory Read/Write</li>
<li>Completion</li>
<li>Message&#x7C7B;&#x578B;</li>
<li>&#x6BCF;&#x79CD;TLP&#x4F5C;&#x4E3A;ADT&#x53D8;&#x4F53;</li>
</ul>
</li>
<li><p><strong>&#x72B6;&#x6001;&#x7A7A;&#x95F4;&#x5B9A;&#x4E49;</strong>&#xFF1A;</p>
<ul>
<li>IDLE&#x3001;HEADER&#x3001;DATA&#x3001;DIGEST&#x72B6;&#x6001;</li>
<li>&#x9519;&#x8BEF;&#x5904;&#x7406;&#x72B6;&#x6001;</li>
<li>&#x4F7F;&#x7528;Sum&#x7C7B;&#x578B;&#x786E;&#x4FDD;&#x5B8C;&#x5907;&#x6027;</li>
</ul>
</li>
<li><p><strong>&#x4FE1;&#x7528;&#x6D41;&#x63A7;&#x5236;</strong>&#xFF1A;</p>
<ul>
<li>Posted/Non-Posted/Completion&#x4FE1;&#x7528;</li>
<li>&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;&#x4FE1;&#x7528;&#x8BA1;&#x6570;&#x5668;</li>
</ul>
</li>
</ol>
<h3 id="843-&#x5B9E;&#x6218;&#x6848;&#x4F8B;&#xFF1A;uart&#x63A7;&#x5236;&#x5668;&#x5B9E;&#x73B0;">8.4.3 &#x5B9E;&#x6218;&#x6848;&#x4F8B;&#xFF1A;UART&#x63A7;&#x5236;&#x5668;&#x5B9E;&#x73B0;</h3>
<p><strong>&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#x62C6;&#x89E3;</strong>&#xFF1A;</p>
<ol>
<li><p><strong>&#x6CE2;&#x7279;&#x7387;&#x751F;&#x6210;&#x5668;</strong>&#xFF1A;</p>
<ul>
<li>&#x53C2;&#x6570;&#x5316;&#x65F6;&#x949F;&#x5206;&#x9891;</li>
<li>&#x7CBE;&#x786E;&#x91C7;&#x6837;&#x70B9;&#x63A7;&#x5236;</li>
</ul>
</li>
<li><p><strong>&#x53D1;&#x9001;&#x72B6;&#x6001;&#x673A;</strong>&#xFF1A;</p>
<ul>
<li>START&#x3001;DATA[0-7]&#x3001;PARITY&#x3001;STOP&#x72B6;&#x6001;</li>
<li>&#x81EA;&#x52A8;&#x5947;&#x5076;&#x6821;&#x9A8C;&#x751F;&#x6210;</li>
</ul>
</li>
<li><p><strong>&#x63A5;&#x6536;&#x72B6;&#x6001;&#x673A;</strong>&#xFF1A;</p>
<ul>
<li>&#x8FC7;&#x91C7;&#x6837;&#x4E0E;&#x6295;&#x7968;&#x903B;&#x8F91;</li>
<li>&#x8D77;&#x59CB;&#x4F4D;&#x68C0;&#x6D4B;&#x53BB;&#x6296;&#x52A8;</li>
<li>&#x5E27;&#x9519;&#x8BEF;&#x68C0;&#x6D4B;</li>
</ul>
</li>
</ol>
<p><strong>&#x8D44;&#x6E90;&#x4F7F;&#x7528;</strong>&#xFF1A;</p>
<ul>
<li>&#x5B8C;&#x6574;UART&#xFF1A;~120 LUTs</li>
<li>&#x652F;&#x6301;115200-3Mbps</li>
<li>&#x5305;&#x542B;16&#x6DF1;&#x5EA6;FIFO&#xFF1A;+1 BRAM</li>
</ul>
<h2 id="85-&#x4E0E;&#x4F20;&#x7EDF;hdl&#x4E92;&#x64CD;&#x4F5C;">8.5 &#x4E0E;&#x4F20;&#x7EDF;HDL&#x4E92;&#x64CD;&#x4F5C;</h2>
<h3 id="851-verilogvhdl&#x6A21;&#x5757;&#x96C6;&#x6210;">8.5.1 Verilog/VHDL&#x6A21;&#x5757;&#x96C6;&#x6210;</h3>
<p>&#x5B9E;&#x9645;&#x9879;&#x76EE;&#x4E2D;&#x7ECF;&#x5E38;&#x9700;&#x8981;&#x96C6;&#x6210;&#x73B0;&#x6709;IP&#x6838;&#xFF0C;Clash&#x63D0;&#x4F9B;&#x4E86;&#x7075;&#x6D3B;&#x7684;&#x4E92;&#x64CD;&#x4F5C;&#x673A;&#x5236;&#x3002;</p>
<p><strong>&#x5916;&#x90E8;&#x6A21;&#x5757;&#x58F0;&#x660E;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x5BFC;&#x5165;Verilog&#x6A21;&#x5757;</span>
<span class="hljs-meta">{-# ANN ddr4Controller (Synthesize
  { t_name = &quot;ddr4_controller&quot;
  , t_inputs = [&quot;clk&quot;, &quot;rst&quot;, &quot;cmd&quot;, &quot;addr&quot;, &quot;wdata&quot;]
  , t_output = &quot;rdata&quot;
  }) #-}</span>
</code></pre>
<p><strong>&#x9ED1;&#x76D2;&#x5B9E;&#x4F8B;&#x5316;&#x6D41;&#x7A0B;</strong>&#xFF1A;</p>
<ol>
<li>&#x5B9A;&#x4E49;Haskell&#x7C7B;&#x578B;&#x7B7E;&#x540D;</li>
<li>&#x6DFB;&#x52A0;&#x7EFC;&#x5408;&#x6807;&#x6CE8;</li>
<li>&#x63D0;&#x4F9B;Verilog/VHDL&#x5B9E;&#x73B0;</li>
<li>&#x7C7B;&#x578B;&#x68C0;&#x67E5;&#x786E;&#x4FDD;&#x63A5;&#x53E3;&#x5339;&#x914D;</li>
</ol>
<h3 id="852-ip&#x6838;&#x5C01;&#x88C5;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;">8.5.2 IP&#x6838;&#x5C01;&#x88C5;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;</h3>
<p><strong>&#x5E94;&#x7528;&#x5B9E;&#x4F8B;&#xFF1A;Xilinx MIG DDR4&#x63A7;&#x5236;&#x5668;&#x5C01;&#x88C5;</strong></p>
<ol>
<li><p><strong>AXI&#x63A5;&#x53E3;&#x7C7B;&#x578B;&#x5316;</strong>&#xFF1A;</p>
<ul>
<li>AW&#x3001;W&#x3001;B&#x3001;AR&#x3001;R&#x901A;&#x9053;&#x5EFA;&#x6A21;</li>
<li>&#x7A81;&#x53D1;&#x7C7B;&#x578B;&#x4E0E;&#x957F;&#x5EA6;&#x7EA6;&#x675F;</li>
</ul>
</li>
<li><p><strong>&#x521D;&#x59CB;&#x5316;&#x5E8F;&#x5217;&#x62BD;&#x8C61;</strong>&#xFF1A;</p>
<ul>
<li>&#x6821;&#x51C6;&#x72B6;&#x6001;&#x673A;&#x76D1;&#x63A7;</li>
<li>&#x9519;&#x8BEF;&#x5904;&#x7406;&#x4E0E;&#x91CD;&#x8BD5;</li>
</ul>
</li>
<li><p><strong>&#x6027;&#x80FD;&#x8BA1;&#x6570;&#x5668;&#x96C6;&#x6210;</strong>&#xFF1A;</p>
<ul>
<li>&#x8BFB;&#x5199;&#x5E26;&#x5BBD;&#x7EDF;&#x8BA1;</li>
<li>&#x5EF6;&#x8FDF;&#x76F4;&#x65B9;&#x56FE;</li>
</ul>
</li>
</ol>
<h3 id="853-&#x6DF7;&#x5408;&#x8BED;&#x8A00;&#x9879;&#x76EE;&#x7EC4;&#x7EC7;">8.5.3 &#x6DF7;&#x5408;&#x8BED;&#x8A00;&#x9879;&#x76EE;&#x7EC4;&#x7EC7;</h3>
<p><strong>&#x9879;&#x76EE;&#x7ED3;&#x6784;&#x5EFA;&#x8BAE;</strong>&#xFF1A;</p>
<pre><code>project/
&#x251C;&#x2500;&#x2500; clash/          # Clash&#x6E90;&#x7801;
&#x251C;&#x2500;&#x2500; verilog/        # &#x624B;&#x5199;Verilog
&#x251C;&#x2500;&#x2500; ip/             # &#x7B2C;&#x4E09;&#x65B9;IP
&#x2514;&#x2500;&#x2500; tb/             # &#x6DF7;&#x5408;&#x6D4B;&#x8BD5;&#x5E73;&#x53F0;
</code></pre><p><strong>&#x6784;&#x5EFA;&#x7CFB;&#x7EDF;&#x96C6;&#x6210;</strong>&#xFF1A;</p>
<ul>
<li>Clash&#x751F;&#x6210;Verilog&#x7EB3;&#x5165;Vivado&#x5DE5;&#x7A0B;</li>
<li>&#x4FDD;&#x6301;&#x6A21;&#x5757;&#x8FB9;&#x754C;&#x6E05;&#x6670;</li>
<li>&#x7248;&#x672C;&#x63A7;&#x5236;&#x7B56;&#x7565;</li>
</ul>
<h2 id="86-evm&#x5B57;&#x8282;&#x7801;&#x6267;&#x884C;&#x5F15;&#x64CE;&#x5B9E;&#x73B0;">8.6 EVM&#x5B57;&#x8282;&#x7801;&#x6267;&#x884C;&#x5F15;&#x64CE;&#x5B9E;&#x73B0;</h2>
<h3 id="861-evm&#x67B6;&#x6784;&#x6982;&#x8FF0;&#x4E0E;clash&#x5EFA;&#x6A21;&#x4F18;&#x52BF;">8.6.1 EVM&#x67B6;&#x6784;&#x6982;&#x8FF0;&#x4E0E;Clash&#x5EFA;&#x6A21;&#x4F18;&#x52BF;</h3>
<p>&#x4EE5;&#x592A;&#x574A;&#x865A;&#x62DF;&#x673A;(EVM)&#x662F;&#x4E00;&#x4E2A;&#x6808;&#x5F0F;&#x865A;&#x62DF;&#x673A;&#xFF0C;&#x6267;&#x884C;&#x667A;&#x80FD;&#x5408;&#x7EA6;&#x5B57;&#x8282;&#x7801;&#x3002;&#x4F7F;&#x7528;Clash&#x5B9E;&#x73B0;EVM&#x5E26;&#x6765;&#x72EC;&#x7279;&#x4F18;&#x52BF;&#xFF1A;</p>
<p><strong>&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x4FDD;&#x8BC1;</strong>&#xFF1A;</p>
<ul>
<li>256&#x4F4D;&#x8FD0;&#x7B97;&#x7684;&#x7C7B;&#x578B;&#x6B63;&#x786E;&#x6027;</li>
<li>Gas&#x8BA1;&#x7B97;&#x4E0D;&#x4F1A;&#x6EA2;&#x51FA;</li>
<li>&#x6808;&#x6DF1;&#x5EA6;&#x8FB9;&#x754C;&#x68C0;&#x67E5;</li>
<li>&#x5185;&#x5B58;&#x8BBF;&#x95EE;&#x5B89;&#x5168;</li>
</ul>
<p><strong>&#x51FD;&#x6570;&#x5F0F;&#x5EFA;&#x6A21;&#x4F18;&#x52BF;</strong>&#xFF1A;</p>
<ul>
<li>&#x6307;&#x4EE4;&#x8BED;&#x4E49;&#x7684;&#x7EAF;&#x51FD;&#x6570;&#x8868;&#x8FBE;</li>
<li>&#x72B6;&#x6001;&#x8F6C;&#x6362;&#x7684;&#x7EC4;&#x5408;&#x6027;</li>
<li>&#x6613;&#x4E8E;&#x5F62;&#x5F0F;&#x5316;&#x9A8C;&#x8BC1;</li>
</ul>
<h3 id="862-&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;evm&#x6838;&#x5FC3;&#x6570;&#x636E;&#x7ED3;&#x6784;">8.6.2 &#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;EVM&#x6838;&#x5FC3;&#x6570;&#x636E;&#x7ED3;&#x6784;</h3>
<p><strong>256&#x4F4D;&#x5B57;&#x7C7B;&#x578B;&#x5B9A;&#x4E49;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x57FA;&#x7840;&#x7C7B;&#x578B;&#x5B9A;&#x4E49;</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Word256</span> = <span class="hljs-type">BitVector</span> 256</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Address</span> = <span class="hljs-type">BitVector</span> 160</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Byte</span> = <span class="hljs-type">BitVector</span> 8</span>

<span class="hljs-comment">-- &#x5E26;&#x7EA6;&#x675F;&#x7684;&#x65B0;&#x7C7B;&#x578B;&#x5305;&#x88C5;</span>
<span class="hljs-class"><span class="hljs-keyword">newtype</span> <span class="hljs-type">EVMWord</span> = <span class="hljs-type">EVMWord</span> { <span class="hljs-title">unWord</span> :: <span class="hljs-type">Word256</span> }</span>
  <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Eq</span>, <span class="hljs-type">Show</span>, <span class="hljs-type">Generic</span>, <span class="hljs-type">NFDataX</span>)

<span class="hljs-comment">-- &#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;&#x7B97;&#x672F;&#x8FD0;&#x7B97;</span>
<span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">Num</span> <span class="hljs-type">EVMWord</span> <span class="hljs-keyword">where</span></span>
  <span class="hljs-type">EVMWord</span> a + <span class="hljs-type">EVMWord</span> b = <span class="hljs-type">EVMWord</span> (a + b)
  <span class="hljs-type">EVMWord</span> a * <span class="hljs-type">EVMWord</span> b = <span class="hljs-type">EVMWord</span> (a * b)
  <span class="hljs-comment">-- &#x81EA;&#x52A8;&#x5904;&#x7406;&#x6EA2;&#x51FA;&#x8BED;&#x4E49;</span>

<span class="hljs-comment">-- &#x6709;&#x7B26;&#x53F7;&#x8FD0;&#x7B97;&#x7684;&#x5355;&#x72EC;&#x7C7B;&#x578B;</span>
<span class="hljs-class"><span class="hljs-keyword">newtype</span> <span class="hljs-type">SignedWord</span> = <span class="hljs-type">SignedWord</span> { <span class="hljs-title">unSigned</span> :: <span class="hljs-type">Signed</span> 256 }</span>
  <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Eq</span>, <span class="hljs-type">Show</span>, <span class="hljs-type">Generic</span>, <span class="hljs-type">NFDataX</span>)
</code></pre>
<p><strong>EVM&#x6808;&#x7684;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x5B9E;&#x73B0;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x6808;&#x6DF1;&#x5EA6;&#x4F5C;&#x4E3A;&#x7C7B;&#x578B;&#x53C2;&#x6570;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">Stack</span> (<span class="hljs-title">n</span> :: <span class="hljs-type">Nat</span>) = <span class="hljs-type">Stack</span></span>
  { stackData  :: <span class="hljs-type">Vec</span> n <span class="hljs-type">EVMWord</span>
  , stackDepth :: <span class="hljs-type">Index</span> (n + <span class="hljs-number">1</span>)  <span class="hljs-comment">-- &#x5F53;&#x524D;&#x6DF1;&#x5EA6;</span>
  } <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Generic</span>, <span class="hljs-type">NFDataX</span>)

<span class="hljs-comment">-- &#x6700;&#x5927;&#x6808;&#x6DF1;&#x5EA6;</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">MaxStackDepth</span> = 1024</span>

<span class="hljs-comment">-- &#x6808;&#x64CD;&#x4F5C;&#x7684;&#x7C7B;&#x578B;&#x7B7E;&#x540D;&#x81EA;&#x52A8;&#x4FDD;&#x8BC1;&#x5B89;&#x5168;&#x6027;</span>
<span class="hljs-title">push</span> :: <span class="hljs-type">EVMWord</span> -&gt; <span class="hljs-type">Stack</span> n -&gt; <span class="hljs-type">Maybe</span> (<span class="hljs-type">Stack</span> n)
<span class="hljs-title">push</span> word stack@(<span class="hljs-type">Stack</span> vec depth) = 
  <span class="hljs-keyword">if</span> depth &lt; maxBound
  <span class="hljs-keyword">then</span> <span class="hljs-type">Just</span> $ <span class="hljs-type">Stack</span> (replace depth word vec) (depth + <span class="hljs-number">1</span>)
  <span class="hljs-keyword">else</span> <span class="hljs-type">Nothing</span>  <span class="hljs-comment">-- &#x6808;&#x6EA2;&#x51FA;</span>

<span class="hljs-title">pop</span> :: <span class="hljs-type">Stack</span> n -&gt; <span class="hljs-type">Maybe</span> (<span class="hljs-type">EVMWord</span>, <span class="hljs-type">Stack</span> n)
<span class="hljs-title">pop</span> (<span class="hljs-type">Stack</span> vec depth) = 
  <span class="hljs-keyword">if</span> depth &gt; <span class="hljs-number">0</span>
  <span class="hljs-keyword">then</span> <span class="hljs-keyword">let</span> idx = depth - <span class="hljs-number">1</span>
       <span class="hljs-keyword">in</span> <span class="hljs-type">Just</span> (vec !! idx, <span class="hljs-type">Stack</span> vec idx)
  <span class="hljs-keyword">else</span> <span class="hljs-type">Nothing</span>  <span class="hljs-comment">-- &#x6808;&#x4E0B;&#x6EA2;</span>

<span class="hljs-comment">-- DUP&#x548C;SWAP&#x7684;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x5B9E;&#x73B0;</span>
<span class="hljs-title">dupN</span> :: (<span class="hljs-type">KnownNat</span> n, n &lt;= <span class="hljs-number">16</span>) =&gt; <span class="hljs-type">SNat</span> n -&gt; <span class="hljs-type">Stack</span> s -&gt; <span class="hljs-type">Maybe</span> (<span class="hljs-type">Stack</span> s)
<span class="hljs-title">swapN</span> :: (<span class="hljs-type">KnownNat</span> n, n &lt;= <span class="hljs-number">16</span>) =&gt; <span class="hljs-type">SNat</span> n -&gt; <span class="hljs-type">Stack</span> s -&gt; <span class="hljs-type">Maybe</span> (<span class="hljs-type">Stack</span> s)
</code></pre>
<p><strong>&#x5185;&#x5B58;&#x5B50;&#x7CFB;&#x7EDF;&#x7C7B;&#x578B;&#x5EFA;&#x6A21;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x7A00;&#x758F;&#x5185;&#x5B58;&#x8868;&#x793A;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">Memory</span> = <span class="hljs-type">Memory</span></span>
  { memPages   :: <span class="hljs-type">Map</span> (<span class="hljs-type">BitVector</span> <span class="hljs-number">20</span>) <span class="hljs-type">MemPage</span>  <span class="hljs-comment">-- 4KB&#x9875;</span>
  , memMaxAddr :: <span class="hljs-type">BitVector</span> <span class="hljs-number">256</span>               <span class="hljs-comment">-- &#x6700;&#x9AD8;&#x8BBF;&#x95EE;&#x5730;&#x5740;</span>
  } <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Generic</span>, <span class="hljs-type">NFDataX</span>)

<span class="hljs-comment">-- &#x5185;&#x5B58;&#x9875;&#x5B9A;&#x4E49;</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">MemPage</span> = <span class="hljs-type">Vec</span> 4096 <span class="hljs-type">Byte</span></span>

<span class="hljs-comment">-- &#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;&#x5185;&#x5B58;&#x64CD;&#x4F5C;</span>
<span class="hljs-title">mload</span> :: <span class="hljs-type">BitVector</span> <span class="hljs-number">256</span> -&gt; <span class="hljs-type">Memory</span> -&gt; <span class="hljs-type">EVMWord</span>
<span class="hljs-title">mstore</span> :: <span class="hljs-type">BitVector</span> <span class="hljs-number">256</span> -&gt; <span class="hljs-type">EVMWord</span> -&gt; <span class="hljs-type">Memory</span> -&gt; <span class="hljs-type">Memory</span>

<span class="hljs-comment">-- Gas&#x8BA1;&#x7B97;&#x96C6;&#x6210;&#x5728;&#x7C7B;&#x578B;&#x4E2D;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">MemOp</span> a = <span class="hljs-type">MemOp</span></span>
  { memOpResult :: a
  , memOpGasCost :: <span class="hljs-type">BitVector</span> <span class="hljs-number">256</span>
  , memOpNewMem :: <span class="hljs-type">Memory</span>
  } <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Functor</span>, <span class="hljs-type">Generic</span>, <span class="hljs-type">NFDataX</span>)
</code></pre>
<h3 id="863-clash-evm&#x6267;&#x884C;&#x5F15;&#x64CE;&#x67B6;&#x6784;">8.6.3 Clash EVM&#x6267;&#x884C;&#x5F15;&#x64CE;&#x67B6;&#x6784;</h3>
<p><strong>&#x6307;&#x4EE4;ADT&#x5B9A;&#x4E49;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x5B8C;&#x6574;&#x7684;EVM&#x6307;&#x4EE4;&#x96C6;&#x7C7B;&#x578B;&#x5EFA;&#x6A21;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">Opcode</span></span>
  <span class="hljs-comment">-- &#x7B97;&#x672F;&#x8FD0;&#x7B97;</span>
  = <span class="hljs-type">ADD</span> | <span class="hljs-type">MUL</span> | <span class="hljs-type">SUB</span> | <span class="hljs-type">DIV</span> | <span class="hljs-type">SDIV</span> | <span class="hljs-type">MOD</span> | <span class="hljs-type">SMOD</span> 
  | <span class="hljs-type">ADDMOD</span> | <span class="hljs-type">MULMOD</span> | <span class="hljs-type">EXP</span> | <span class="hljs-type">SIGNEXTEND</span>
  <span class="hljs-comment">-- &#x6BD4;&#x8F83;&#x8FD0;&#x7B97;</span>
  | <span class="hljs-type">LT</span> | <span class="hljs-type">GT</span> | <span class="hljs-type">SLT</span> | <span class="hljs-type">SGT</span> | <span class="hljs-type">EQ</span> | <span class="hljs-type">ISZERO</span>
  <span class="hljs-comment">-- &#x4F4D;&#x8FD0;&#x7B97;</span>
  | <span class="hljs-type">AND</span> | <span class="hljs-type">OR</span> | <span class="hljs-type">XOR</span> | <span class="hljs-type">NOT</span> | <span class="hljs-type">BYTE</span> | <span class="hljs-type">SHL</span> | <span class="hljs-type">SHR</span> | <span class="hljs-type">SAR</span>
  <span class="hljs-comment">-- &#x54C8;&#x5E0C;</span>
  | <span class="hljs-type">SHA3</span>
  <span class="hljs-comment">-- &#x73AF;&#x5883;&#x4FE1;&#x606F;</span>
  | <span class="hljs-type">ADDRESS</span> | <span class="hljs-type">BALANCE</span> | <span class="hljs-type">ORIGIN</span> | <span class="hljs-type">CALLER</span> | <span class="hljs-type">CALLVALUE</span>
  | <span class="hljs-type">CALLDATALOAD</span> | <span class="hljs-type">CALLDATASIZE</span> | <span class="hljs-type">CALLDATACOPY</span>
  | <span class="hljs-type">CODESIZE</span> | <span class="hljs-type">CODECOPY</span> | <span class="hljs-type">GASPRICE</span> | <span class="hljs-type">EXTCODESIZE</span>
  | <span class="hljs-type">EXTCODECOPY</span> | <span class="hljs-type">RETURNDATASIZE</span> | <span class="hljs-type">RETURNDATACOPY</span>
  <span class="hljs-comment">-- &#x533A;&#x5757;&#x4FE1;&#x606F;</span>
  | <span class="hljs-type">BLOCKHASH</span> | <span class="hljs-type">COINBASE</span> | <span class="hljs-type">TIMESTAMP</span> | <span class="hljs-type">NUMBER</span> 
  | <span class="hljs-type">DIFFICULTY</span> | <span class="hljs-type">GASLIMIT</span> | <span class="hljs-type">CHAINID</span> | <span class="hljs-type">SELFBALANCE</span>
  <span class="hljs-comment">-- &#x6808;&#x64CD;&#x4F5C;</span>
  | <span class="hljs-type">POP</span> | <span class="hljs-type">MLOAD</span> | <span class="hljs-type">MSTORE</span> | <span class="hljs-type">MSTORE8</span> | <span class="hljs-type">SLOAD</span> | <span class="hljs-type">SSTORE</span>
  | <span class="hljs-type">JUMP</span> | <span class="hljs-type">JUMPI</span> | <span class="hljs-type">PC</span> | <span class="hljs-type">MSIZE</span> | <span class="hljs-type">GAS</span> | <span class="hljs-type">JUMPDEST</span>
  <span class="hljs-comment">-- PUSH&#x6307;&#x4EE4;</span>
  | <span class="hljs-type">PUSH</span> (<span class="hljs-type">Index</span> <span class="hljs-number">33</span>) (<span class="hljs-type">Vec</span> n <span class="hljs-type">Byte</span>)  <span class="hljs-comment">-- PUSH1&#x5230;PUSH32</span>
  <span class="hljs-comment">-- DUP&#x548C;SWAP</span>
  | <span class="hljs-type">DUP</span> (<span class="hljs-type">Index</span> <span class="hljs-number">17</span>)   <span class="hljs-comment">-- DUP1&#x5230;DUP16</span>
  | <span class="hljs-type">SWAP</span> (<span class="hljs-type">Index</span> <span class="hljs-number">17</span>)  <span class="hljs-comment">-- SWAP1&#x5230;SWAP16</span>
  <span class="hljs-comment">-- &#x65E5;&#x5FD7;</span>
  | <span class="hljs-type">LOG</span> (<span class="hljs-type">Index</span> <span class="hljs-number">5</span>)    <span class="hljs-comment">-- LOG0&#x5230;LOG4</span>
  <span class="hljs-comment">-- &#x7CFB;&#x7EDF;&#x64CD;&#x4F5C;</span>
  | <span class="hljs-type">CREATE</span> | <span class="hljs-type">CALL</span> | <span class="hljs-type">CALLCODE</span> | <span class="hljs-type">RETURN</span> | <span class="hljs-type">DELEGATECALL</span>
  | <span class="hljs-type">CREATE2</span> | <span class="hljs-type">STATICCALL</span> | <span class="hljs-type">REVERT</span> | <span class="hljs-type">SELFDESTRUCT</span>
  <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Eq</span>, <span class="hljs-type">Show</span>, <span class="hljs-type">Generic</span>, <span class="hljs-type">NFDataX</span>)
</code></pre>
<p><strong>EVM&#x72B6;&#x6001;&#x673A;&#x5B9A;&#x4E49;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- EVM&#x5B8C;&#x6574;&#x72B6;&#x6001;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">EVMState</span> = <span class="hljs-type">EVMState</span></span>
  { evmPC        :: <span class="hljs-type">BitVector</span> <span class="hljs-number">256</span>      <span class="hljs-comment">-- &#x7A0B;&#x5E8F;&#x8BA1;&#x6570;&#x5668;</span>
  , evmStack     :: <span class="hljs-type">Stack</span> <span class="hljs-type">MaxStackDepth</span> <span class="hljs-comment">-- &#x64CD;&#x4F5C;&#x6808;</span>
  , evmMemory    :: <span class="hljs-type">Memory</span>              <span class="hljs-comment">-- &#x5185;&#x5B58;</span>
  , evmStorage   :: <span class="hljs-type">Storage</span>             <span class="hljs-comment">-- &#x6301;&#x4E45;&#x5B58;&#x50A8;</span>
  , evmGasLeft   :: <span class="hljs-type">BitVector</span> <span class="hljs-number">256</span>      <span class="hljs-comment">-- &#x5269;&#x4F59;Gas</span>
  , evmReturnData:: <span class="hljs-type">Vec</span> <span class="hljs-number">1024</span> <span class="hljs-type">Byte</span>       <span class="hljs-comment">-- &#x8FD4;&#x56DE;&#x6570;&#x636E;&#x7F13;&#x51B2;</span>
  , evmLogs      :: <span class="hljs-type">Vec</span> <span class="hljs-number">256</span> <span class="hljs-type">LogEntry</span>    <span class="hljs-comment">-- &#x65E5;&#x5FD7;&#x6761;&#x76EE;</span>
  , evmCallDepth :: <span class="hljs-type">Index</span> <span class="hljs-number">1025</span>          <span class="hljs-comment">-- &#x8C03;&#x7528;&#x6DF1;&#x5EA6;</span>
  , evmHalted    :: <span class="hljs-type">Bool</span>                <span class="hljs-comment">-- &#x6267;&#x884C;&#x72B6;&#x6001;</span>
  , evmReverted  :: <span class="hljs-type">Bool</span>                <span class="hljs-comment">-- &#x56DE;&#x6EDA;&#x6807;&#x5FD7;</span>
  } <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Generic</span>, <span class="hljs-type">NFDataX</span>)

<span class="hljs-comment">-- &#x72B6;&#x6001;&#x8F6C;&#x6362;&#x51FD;&#x6570;&#x7684;&#x7C7B;&#x578B;&#x7B7E;&#x540D;</span>
<span class="hljs-title">executeInstruction</span> :: <span class="hljs-type">Opcode</span> -&gt; <span class="hljs-type">State</span> <span class="hljs-type">EVMState</span> (<span class="hljs-type">Maybe</span> ())
</code></pre>
<p><strong>&#x6D41;&#x6C34;&#x7EBF;Mealy&#x673A;&#x5B9E;&#x73B0;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x6267;&#x884C;&#x5F15;&#x64CE;&#x9876;&#x5C42;</span>
<span class="hljs-title">evmCore</span> 
  :: <span class="hljs-type">Clock</span> <span class="hljs-type">System</span>
  -&gt; <span class="hljs-type">Reset</span> <span class="hljs-type">System</span>
  -&gt; <span class="hljs-type">Enable</span> <span class="hljs-type">System</span>
  -&gt; <span class="hljs-type">Signal</span> <span class="hljs-type">System</span> (<span class="hljs-type">Maybe</span> <span class="hljs-type">Opcode</span>)
  -&gt; <span class="hljs-type">Signal</span> <span class="hljs-type">System</span> <span class="hljs-type">EVMState</span>
<span class="hljs-title">evmCore</span> = mealy evmStep initialState
  <span class="hljs-keyword">where</span>
    evmStep :: <span class="hljs-type">EVMState</span> -&gt; <span class="hljs-type">Maybe</span> <span class="hljs-type">Opcode</span> -&gt; (<span class="hljs-type">EVMState</span>, <span class="hljs-type">EVMState</span>)
    evmStep state <span class="hljs-type">Nothing</span> = (state, state)  <span class="hljs-comment">-- &#x7A7A;&#x95F2;</span>
    evmStep state (<span class="hljs-type">Just</span> op) = 
      <span class="hljs-keyword">case</span> runState (executeInstruction op) state <span class="hljs-keyword">of</span>
        (<span class="hljs-type">Nothing</span>, state&apos;) -&gt; (state&apos;, state&apos;)  <span class="hljs-comment">-- &#x9519;&#x8BEF;</span>
        (<span class="hljs-type">Just</span> (), state&apos;) -&gt; (state&apos;, state&apos;)  <span class="hljs-comment">-- &#x6210;&#x529F;</span>
</code></pre>
<h3 id="864-256&#x4F4D;alu&#x7684;clash&#x5B9E;&#x73B0;">8.6.4 256&#x4F4D;ALU&#x7684;Clash&#x5B9E;&#x73B0;</h3>
<p><strong>&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;ALU&#x8BBE;&#x8BA1;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- ALU&#x64CD;&#x4F5C;&#x7C7B;&#x578B;&#x7C7B;</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">ArithOp</span> op <span class="hljs-keyword">where</span></span>
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">OpResult</span> op :: *</span>
  evalOp :: op -&gt; <span class="hljs-type">EVMWord</span> -&gt; <span class="hljs-type">EVMWord</span> -&gt; <span class="hljs-type">OpResult</span> op

<span class="hljs-comment">-- &#x5177;&#x4F53;&#x64CD;&#x4F5C;&#x5B9E;&#x4F8B;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">AddOp</span> = <span class="hljs-type">AddOp</span></span>
<span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">ArithOp</span> <span class="hljs-type">AddOp</span> <span class="hljs-keyword">where</span></span>
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">OpResult</span> <span class="hljs-type">AddOp</span> = <span class="hljs-type">EVMWord</span></span>
  evalOp _ = (+)

<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">DivOp</span> = <span class="hljs-type">DivOp</span>  </span>
<span class="hljs-class"><span class="hljs-keyword">instance</span> <span class="hljs-type">ArithOp</span> <span class="hljs-type">DivOp</span> <span class="hljs-keyword">where</span></span>
  <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">OpResult</span> <span class="hljs-type">DivOp</span> = <span class="hljs-type">EVMWord</span></span>
  evalOp _ a b = <span class="hljs-keyword">if</span> b == <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> a `div` b

<span class="hljs-comment">-- &#x6A21;&#x8FD0;&#x7B97;&#x9700;&#x8981;&#x4E09;&#x4E2A;&#x64CD;&#x4F5C;&#x6570;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">AddModOp</span> = <span class="hljs-type">AddModOp</span></span>
<span class="hljs-title">evalAddMod</span> :: <span class="hljs-type">EVMWord</span> -&gt; <span class="hljs-type">EVMWord</span> -&gt; <span class="hljs-type">EVMWord</span> -&gt; <span class="hljs-type">EVMWord</span>
<span class="hljs-title">evalAddMod</span> a b n = 
  <span class="hljs-keyword">if</span> n == <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">0</span> 
  <span class="hljs-keyword">else</span> <span class="hljs-type">EVMWord</span> $ (unWord a + unWord b) `mod` unWord n
</code></pre>
<p><strong>&#x6D41;&#x6C34;&#x7EBF;ALU&#x5B9E;&#x73B0;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- 256&#x4F4D;&#x4E58;&#x6CD5;&#x5668;&#x6D41;&#x6C34;&#x7EBF;</span>
<span class="hljs-title">mul256Pipeline</span> 
  :: <span class="hljs-type">Clock</span> dom
  -&gt; <span class="hljs-type">Reset</span> dom
  -&gt; <span class="hljs-type">Enable</span> dom
  -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">EVMWord</span>, <span class="hljs-type">EVMWord</span>)
  -&gt; <span class="hljs-type">Signal</span> dom <span class="hljs-type">EVMWord</span>
<span class="hljs-title">mul256Pipeline</span> clk rst en inputs = 
  <span class="hljs-comment">-- Karatsuba&#x5206;&#x89E3;&#x4E3A;128&#x4F4D;&#x4E58;&#x6CD5;</span>
  <span class="hljs-keyword">let</span> (aH, aL) = unbundle $ split128 &lt;$&gt; fst &lt;$&gt; inputs
      (bH, bL) = unbundle $ split128 &lt;$&gt; snd &lt;$&gt; inputs

      <span class="hljs-comment">-- &#x4E09;&#x4E2A;128&#x4F4D;&#x4E58;&#x6CD5;&#x5E76;&#x884C;</span>
      p0 = register clk rst en <span class="hljs-number">0</span> (mul128 &lt;$&gt; aL &lt;*&gt; bL)
      p1 = register clk rst en <span class="hljs-number">0</span> (mul128 &lt;$&gt; (aL + aH) &lt;*&gt; (bL + bH))
      p2 = register clk rst en <span class="hljs-number">0</span> (mul128 &lt;$&gt; aH &lt;*&gt; bH)

      <span class="hljs-comment">-- &#x7EC4;&#x5408;&#x7ED3;&#x679C;&#xFF08;&#x7B2C;&#x4E8C;&#x7EA7;&#x6D41;&#x6C34;&#x7EBF;&#xFF09;</span>
      result = register clk rst en <span class="hljs-number">0</span> $ 
        combineKaratsuba &lt;$&gt; p0 &lt;*&gt; p1 &lt;*&gt; p2
  <span class="hljs-keyword">in</span> result

<span class="hljs-comment">-- &#x9664;&#x6CD5;&#x5668;&#x4F7F;&#x7528;&#x8FED;&#x4EE3;&#x7B97;&#x6CD5;</span>
<span class="hljs-title">div256Iterative</span>
  :: <span class="hljs-type">Clock</span> dom
  -&gt; <span class="hljs-type">Reset</span> dom  
  -&gt; <span class="hljs-type">Enable</span> dom
  -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Maybe</span> (<span class="hljs-type">EVMWord</span>, <span class="hljs-type">EVMWord</span>))
  -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Maybe</span> <span class="hljs-type">EVMWord</span>)
<span class="hljs-title">div256Iterative</span> = mealy divStep (<span class="hljs-type">Nothing</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  <span class="hljs-keyword">where</span>
    divStep (<span class="hljs-type">Nothing</span>, _, _, _) (<span class="hljs-type">Just</span> (a, b)) = 
      <span class="hljs-comment">-- &#x5F00;&#x59CB;&#x65B0;&#x7684;&#x9664;&#x6CD5;</span>
      ((<span class="hljs-type">Just</span> (a, b), a, <span class="hljs-number">0</span>, <span class="hljs-number">255</span>), <span class="hljs-type">Nothing</span>)
    divStep (<span class="hljs-type">Just</span> (a, b), rem, quot, cnt) <span class="hljs-type">Nothing</span> =
      <span class="hljs-comment">-- &#x7EE7;&#x7EED;&#x8FED;&#x4EE3;</span>
      <span class="hljs-keyword">let</span> rem&apos; = shiftL rem <span class="hljs-number">1</span> .|. (<span class="hljs-keyword">if</span> testBit a cnt <span class="hljs-keyword">then</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>)
          (quot&apos;, rem&apos;&apos;) = <span class="hljs-keyword">if</span> rem&apos; &gt;= b 
                           <span class="hljs-keyword">then</span> (shiftL quot <span class="hljs-number">1</span> .|. <span class="hljs-number">1</span>, rem&apos; - b)
                           <span class="hljs-keyword">else</span> (shiftL quot <span class="hljs-number">1</span>, rem&apos;)
      <span class="hljs-keyword">in</span> <span class="hljs-keyword">if</span> cnt == <span class="hljs-number">0</span>
         <span class="hljs-keyword">then</span> ((<span class="hljs-type">Nothing</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), <span class="hljs-type">Just</span> (<span class="hljs-type">EVMWord</span> quot&apos;))
         <span class="hljs-keyword">else</span> ((<span class="hljs-type">Just</span> (a, b), rem&apos;&apos;, quot&apos;, cnt - <span class="hljs-number">1</span>), <span class="hljs-type">Nothing</span>)
</code></pre>
<h3 id="865-keccak-256&#x54C8;&#x5E0C;&#x52A0;&#x901F;&#x5668;">8.6.5 Keccak-256&#x54C8;&#x5E0C;&#x52A0;&#x901F;&#x5668;</h3>
<p><strong>&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;Keccak&#x5B9E;&#x73B0;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- Keccak&#x72B6;&#x6001;&#x7C7B;&#x578B;</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">KeccakState</span> = <span class="hljs-type">Vec</span> 5 (<span class="hljs-type">Vec</span> 5 (<span class="hljs-type">BitVector</span> 64))</span>

<span class="hljs-comment">-- &#x8F6E;&#x5E38;&#x6570;</span>
<span class="hljs-title">roundConstants</span> :: <span class="hljs-type">Vec</span> <span class="hljs-number">24</span> (<span class="hljs-type">BitVector</span> <span class="hljs-number">64</span>)
<span class="hljs-title">roundConstants</span> = $(listToVecTH [ <span class="hljs-comment">{- 24&#x4E2A;&#x8F6E;&#x5E38;&#x6570; -}</span> ])

<span class="hljs-comment">-- Keccak-f[1600]&#x7F6E;&#x6362;</span>
<span class="hljs-title">keccakF</span> :: <span class="hljs-type">KeccakState</span> -&gt; <span class="hljs-type">KeccakState</span>
<span class="hljs-title">keccakF</span> = fold (.) (map keccakRound (zip indicesI roundConstants))

<span class="hljs-comment">-- &#x5355;&#x8F6E;&#x51FD;&#x6570;</span>
<span class="hljs-title">keccakRound</span> :: (<span class="hljs-type">Index</span> <span class="hljs-number">24</span>, <span class="hljs-type">BitVector</span> <span class="hljs-number">64</span>) -&gt; <span class="hljs-type">KeccakState</span> -&gt; <span class="hljs-type">KeccakState</span>
<span class="hljs-title">keccakRound</span> (_, rc) = iota rc . chi . pi . rho . theta

<span class="hljs-comment">-- &#x3B8;&#x6B65;&#x9AA4;&#xFF1A;&#x5217;&#x5947;&#x5076;&#x6821;&#x9A8C;</span>
<span class="hljs-title">theta</span> :: <span class="hljs-type">KeccakState</span> -&gt; <span class="hljs-type">KeccakState</span>
<span class="hljs-title">theta</span> state = 
  <span class="hljs-keyword">let</span> c = map (fold xor) (transpose state)
      d = zipWith xor (rotateLeft c <span class="hljs-number">1</span>) (map (`rotateL` <span class="hljs-number">1</span>) c)
  <span class="hljs-keyword">in</span> zipWith (zipWith xor) state (repeat d)

<span class="hljs-comment">-- &#x5B8C;&#x6574;&#x7684;Keccak-256&#x5B9E;&#x73B0;</span>
<span class="hljs-title">keccak256</span> 
  :: <span class="hljs-type">Clock</span> dom
  -&gt; <span class="hljs-type">Reset</span> dom
  -&gt; <span class="hljs-type">Enable</span> dom
  -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Maybe</span> (<span class="hljs-type">Vec</span> n <span class="hljs-type">Byte</span>))
  -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Maybe</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> <span class="hljs-type">Byte</span>))
<span class="hljs-title">keccak256</span> = mealy keccakStep initialKeccakState
</code></pre>
<h3 id="866-&#x5B58;&#x50A8;&#x5B50;&#x7CFB;&#x7EDF;&#x4F18;&#x5316;">8.6.6 &#x5B58;&#x50A8;&#x5B50;&#x7CFB;&#x7EDF;&#x4F18;&#x5316;</h3>
<p><strong>Merkle Patricia Trie&#x52A0;&#x901F;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- MPT&#x8282;&#x70B9;&#x7C7B;&#x578B;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">MPTNode</span></span>
  = <span class="hljs-type">Empty</span>
  | <span class="hljs-type">Leaf</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> <span class="hljs-type">Byte</span>) <span class="hljs-type">EVMWord</span>           <span class="hljs-comment">-- key-value</span>
  | <span class="hljs-type">Branch</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">16</span> (<span class="hljs-type">Maybe</span> <span class="hljs-type">MPTNodeRef</span>)) (<span class="hljs-type">Maybe</span> <span class="hljs-type">EVMWord</span>)
  | <span class="hljs-type">Extension</span> (<span class="hljs-type">Vec</span> n <span class="hljs-type">Nibble</span>) <span class="hljs-type">MPTNodeRef</span>
  <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Generic</span>, <span class="hljs-type">NFDataX</span>)

<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">Nibble</span> = <span class="hljs-type">BitVector</span> 4</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">MPTNodeRef</span> = <span class="hljs-type">BitVector</span> 256  <span class="hljs-comment">-- &#x8282;&#x70B9;&#x54C8;&#x5E0C;</span></span>

<span class="hljs-comment">-- &#x786C;&#x4EF6;MPT&#x67E5;&#x627E;&#x5F15;&#x64CE;</span>
<span class="hljs-title">mptLookup</span>
  :: <span class="hljs-type">Clock</span> dom
  -&gt; <span class="hljs-type">Reset</span> dom
  -&gt; <span class="hljs-type">Enable</span> dom
  -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Maybe</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> <span class="hljs-type">Byte</span>))      <span class="hljs-comment">-- &#x67E5;&#x627E;&#x952E;</span>
  -&gt; <span class="hljs-type">Signal</span> dom (<span class="hljs-type">Maybe</span> <span class="hljs-type">EVMWord</span>)            <span class="hljs-comment">-- &#x67E5;&#x627E;&#x7ED3;&#x679C;</span>
<span class="hljs-title">mptLookup</span> = mealy lookupStep (<span class="hljs-type">Idle</span>, <span class="hljs-type">Nothing</span>)
  <span class="hljs-keyword">where</span>
    <span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">LookupState</span> </span>
      = <span class="hljs-type">Idle</span>
      | <span class="hljs-type">Fetching</span> <span class="hljs-type">MPTNodeRef</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">64</span> <span class="hljs-type">Nibble</span>) (<span class="hljs-type">Index</span> <span class="hljs-number">65</span>)
      | <span class="hljs-type">Processing</span> <span class="hljs-type">MPTNode</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">64</span> <span class="hljs-type">Nibble</span>) (<span class="hljs-type">Index</span> <span class="hljs-number">65</span>)
      <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Generic</span>, <span class="hljs-type">NFDataX</span>)
</code></pre>
<p><strong>&#x7F13;&#x5B58;&#x5C42;&#x6B21;&#x7ED3;&#x6784;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- L1&#x7F13;&#x5B58;&#xFF1A;&#x5168;&#x5173;&#x8054;</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">L1Cache</span> = <span class="hljs-type">Vec</span> 64 <span class="hljs-type">CacheLine</span></span>

<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">CacheLine</span> = <span class="hljs-type">CacheLine</span></span>
  { cacheTag   :: <span class="hljs-type">BitVector</span> <span class="hljs-number">256</span>
  , cacheValue :: <span class="hljs-type">EVMWord</span>
  , cacheValid :: <span class="hljs-type">Bool</span>
  , cacheLRU   :: <span class="hljs-type">Index</span> <span class="hljs-number">64</span>
  } <span class="hljs-keyword">deriving</span> (<span class="hljs-type">Generic</span>, <span class="hljs-type">NFDataX</span>)

<span class="hljs-comment">-- &#x5E76;&#x884C;&#x67E5;&#x627E;</span>
<span class="hljs-title">l1Lookup</span> :: <span class="hljs-type">Vec</span> <span class="hljs-number">32</span> <span class="hljs-type">Byte</span> -&gt; <span class="hljs-type">L1Cache</span> -&gt; <span class="hljs-type">Maybe</span> <span class="hljs-type">EVMWord</span>
<span class="hljs-title">l1Lookup</span> key cache = 
  <span class="hljs-keyword">let</span> matches = map (\line -&gt; cacheValid line &amp;&amp; cacheTag line == pack key) cache
      hitIndex = findIndex id matches
  <span class="hljs-keyword">in</span> hitIndex &gt;&gt;= \idx -&gt; <span class="hljs-type">Just</span> (cacheValue (cache !! idx))
</code></pre>
<h3 id="867-gas&#x8BA1;&#x91CF;&#x7684;&#x7C7B;&#x578B;&#x96C6;&#x6210;">8.6.7 Gas&#x8BA1;&#x91CF;&#x7684;&#x7C7B;&#x578B;&#x96C6;&#x6210;</h3>
<p><strong>Gas&#x5B89;&#x5168;&#x7684;&#x6307;&#x4EE4;&#x6267;&#x884C;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- Gas&#x6210;&#x672C;&#x7C7B;&#x578B;&#x7C7B;</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-type">GasCost</span> op <span class="hljs-keyword">where</span></span>
  staticGas :: op -&gt; <span class="hljs-type">BitVector</span> <span class="hljs-number">256</span>
  dynamicGas :: op -&gt; <span class="hljs-type">EVMState</span> -&gt; <span class="hljs-type">BitVector</span> <span class="hljs-number">256</span>

<span class="hljs-comment">-- &#x5E26;Gas&#x68C0;&#x67E5;&#x7684;&#x6267;&#x884C;</span>
<span class="hljs-title">executeWithGas</span> :: (<span class="hljs-type">GasCost</span> op) =&gt; op -&gt; <span class="hljs-type">State</span> <span class="hljs-type">EVMState</span> (<span class="hljs-type">Maybe</span> ())
<span class="hljs-title">executeWithGas</span> op = <span class="hljs-keyword">do</span>
  state &lt;- get
  <span class="hljs-keyword">let</span> staticCost = staticGas op
      dynamicCost = dynamicGas op state
      totalCost = staticCost + dynamicCost

  <span class="hljs-keyword">if</span> evmGasLeft state &gt;= totalCost
  <span class="hljs-keyword">then</span> <span class="hljs-keyword">do</span>
    modify $ \s -&gt; s { evmGasLeft = evmGasLeft s - totalCost }
    executeOp op
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">do</span>
    modify $ \s -&gt; s { evmHalted = <span class="hljs-type">True</span> }
    return <span class="hljs-type">Nothing</span>
</code></pre>
<h3 id="868-&#x5B8C;&#x6574;evm&#x5904;&#x7406;&#x5668;&#x96C6;&#x6210;">8.6.8 &#x5B8C;&#x6574;EVM&#x5904;&#x7406;&#x5668;&#x96C6;&#x6210;</h3>
<p><strong>&#x9876;&#x5C42;&#x6A21;&#x5757;&#x63A5;&#x53E3;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- EVM&#x5904;&#x7406;&#x5668;&#x9876;&#x5C42;</span>
<span class="hljs-title">evmProcessor</span>
  :: <span class="hljs-type">Clock</span> <span class="hljs-type">System</span>
  -&gt; <span class="hljs-type">Reset</span> <span class="hljs-type">System</span>
  -&gt; <span class="hljs-type">Enable</span> <span class="hljs-type">System</span>
  <span class="hljs-comment">-- &#x8F93;&#x5165;&#x63A5;&#x53E3;</span>
  -&gt; <span class="hljs-type">Signal</span> <span class="hljs-type">System</span> (<span class="hljs-type">Maybe</span> <span class="hljs-type">Transaction</span>)
  <span class="hljs-comment">-- &#x8F93;&#x51FA;&#x63A5;&#x53E3;  </span>
  -&gt; ( <span class="hljs-type">Signal</span> <span class="hljs-type">System</span> <span class="hljs-type">ExecutionResult</span>
     , <span class="hljs-type">Signal</span> <span class="hljs-type">System</span> (<span class="hljs-type">Vec</span> <span class="hljs-number">32</span> <span class="hljs-type">Byte</span>)  <span class="hljs-comment">-- &#x72B6;&#x6001;&#x6839;</span>
     )
<span class="hljs-title">evmProcessor</span> clk rst en txIn = 
  <span class="hljs-keyword">let</span> <span class="hljs-comment">-- &#x53D6;&#x6307;&#x5355;&#x5143;</span>
      (pc, fetchReq) = unbundle $ fetchUnit &lt;$&gt; evmState
      opcode = instructionMem clk fetchReq

      <span class="hljs-comment">-- &#x6267;&#x884C;&#x6838;&#x5FC3;</span>
      evmState = register clk rst en initialState $
        evmCore clk rst en opcode

      <span class="hljs-comment">-- &#x72B6;&#x6001;&#x6839;&#x8BA1;&#x7B97;</span>
      stateRoot = register clk rst en (repeat <span class="hljs-number">0</span>) $
        calculateStateRoot &lt;$&gt; evmState

  <span class="hljs-keyword">in</span> (getResult &lt;$&gt; evmState, stateRoot)
</code></pre>
<p><strong>&#x6027;&#x80FD;&#x4F18;&#x5316;&#x6280;&#x672F;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- 1. &#x64CD;&#x4F5C;&#x878D;&#x5408;</span>
<span class="hljs-comment">-- PUSH1 + ADD &#x878D;&#x5408;&#x4E3A;&#x5355;&#x6307;&#x4EE4;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">FusedOp</span> = <span class="hljs-type">PushAdd</span> (<span class="hljs-type">BitVector</span> 8)</span>
<span class="hljs-title">executeFused</span> (<span class="hljs-type">PushAdd</span> n) = <span class="hljs-keyword">do</span>
  a &lt;- popStack
  pushStack (a + fromIntegral n)

<span class="hljs-comment">-- 2. &#x6808;&#x7F13;&#x5B58;&#x4F18;&#x5316;</span>
<span class="hljs-comment">-- &#x6808;&#x9876;&#x5143;&#x7D20;&#x4FDD;&#x5B58;&#x5728;&#x5BC4;&#x5B58;&#x5668;&#x4E2D;</span>
<span class="hljs-class"><span class="hljs-keyword">data</span> <span class="hljs-type">FastStack</span> = <span class="hljs-type">FastStack</span></span>
  { stackTop    :: <span class="hljs-type">Maybe</span> <span class="hljs-type">EVMWord</span>
  , stackRest   :: <span class="hljs-type">Stack</span> <span class="hljs-number">1023</span>
  }

<span class="hljs-comment">-- 3. &#x5206;&#x652F;&#x9884;&#x6D4B;</span>
<span class="hljs-comment">-- JUMPI&#x9884;&#x6D4B;&#x8868;</span>
<span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-type">BranchPredictor</span> = <span class="hljs-type">Vec</span> 256 (<span class="hljs-type">BitVector</span> 256, <span class="hljs-type">Bool</span>)</span>
</code></pre>
<h3 id="869-&#x5F62;&#x5F0F;&#x5316;&#x9A8C;&#x8BC1;&#x96C6;&#x6210;">8.6.9 &#x5F62;&#x5F0F;&#x5316;&#x9A8C;&#x8BC1;&#x96C6;&#x6210;</h3>
<p><strong>&#x4F7F;&#x7528;Clash&#x7684;&#x9A8C;&#x8BC1;&#x4F18;&#x52BF;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x5C5E;&#x6027;&#x89C4;&#x8303;</span>
<span class="hljs-title">prop_addCommutative</span> :: <span class="hljs-type">EVMWord</span> -&gt; <span class="hljs-type">EVMWord</span> -&gt; <span class="hljs-type">Bool</span>
<span class="hljs-title">prop_addCommutative</span> a b = a + b == b + a

<span class="hljs-comment">-- &#x7B26;&#x53F7;&#x6267;&#x884C;&#x652F;&#x6301;</span>
<span class="hljs-title">symbolicEVM</span> :: <span class="hljs-type">Symbolic</span> <span class="hljs-type">EVMState</span>
<span class="hljs-title">symbolicEVM</span> = <span class="hljs-keyword">do</span>
  <span class="hljs-comment">-- &#x521B;&#x5EFA;&#x7B26;&#x53F7;&#x8F93;&#x5165;</span>
  a &lt;- free <span class="hljs-string">&quot;a&quot;</span>
  b &lt;- free <span class="hljs-string">&quot;b&quot;</span>

  <span class="hljs-comment">-- &#x6267;&#x884C;&#x7B26;&#x53F7;&#x8DEF;&#x5F84;</span>
  <span class="hljs-keyword">let</span> state = execState (<span class="hljs-keyword">do</span>
        pushStack a
        pushStack b  
        executeInstruction <span class="hljs-type">ADD</span>) initialState

  <span class="hljs-comment">-- &#x9A8C;&#x8BC1;&#x540E;&#x7F6E;&#x6761;&#x4EF6;</span>
  constrain $ stackTop state == <span class="hljs-type">Just</span> (a + b)
  return state
</code></pre>
<h3 id="8610-&#x5B9E;&#x9645;&#x6027;&#x80FD;&#x6307;&#x6807;&#x4E0E;&#x8D44;&#x6E90;&#x4F7F;&#x7528;">8.6.10 &#x5B9E;&#x9645;&#x6027;&#x80FD;&#x6307;&#x6807;&#x4E0E;&#x8D44;&#x6E90;&#x4F7F;&#x7528;</h3>
<p><strong>Zynq UltraScale+ ZU9EG&#x5B9E;&#x73B0;&#x7ED3;&#x679C;</strong>&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x8D44;&#x6E90;&#x4F7F;&#x7528;&#x7EDF;&#x8BA1;</span>
<span class="hljs-title">resourceUsage</span> :: <span class="hljs-type">ResourceReport</span>
<span class="hljs-title">resourceUsage</span> = <span class="hljs-type">ResourceReport</span>
  { lutUsage     = <span class="hljs-number">52000</span>   <span class="hljs-comment">-- 9.5%</span>
  , ffUsage      = <span class="hljs-number">41000</span>   <span class="hljs-comment">-- 3.8%</span>
  , dspUsage     = <span class="hljs-number">140</span>     <span class="hljs-comment">-- 5.2%</span>
  , bramUsage    = <span class="hljs-number">72</span>      <span class="hljs-comment">-- 8.0%</span>
  , uramUsage    = <span class="hljs-number">36</span>      <span class="hljs-comment">-- 22.5%</span>
  }

<span class="hljs-comment">-- &#x6027;&#x80FD;&#x57FA;&#x51C6;&#x6D4B;&#x8BD5;</span>
<span class="hljs-title">benchmarks</span> :: <span class="hljs-type">BenchmarkResults</span>  
<span class="hljs-title">benchmarks</span> = <span class="hljs-type">BenchmarkResults</span>
  { clockFreq    = <span class="hljs-number">200</span>     <span class="hljs-comment">-- MHz</span>
  , simpleOps    = <span class="hljs-number">195</span>     <span class="hljs-comment">-- M ops/s</span>
  , sha3Latency  = <span class="hljs-number">45</span>      <span class="hljs-comment">-- cycles</span>
  , sloadLatency = <span class="hljs-number">120</span>     <span class="hljs-comment">-- cycles (&#x7F13;&#x5B58;&#x547D;&#x4E2D;)</span>
  , sstoreLatency= <span class="hljs-number">450</span>     <span class="hljs-comment">-- cycles</span>
  }

<span class="hljs-comment">-- &#x76F8;&#x6BD4;&#x8F6F;&#x4EF6;&#x5B9E;&#x73B0;&#x7684;&#x52A0;&#x901F;&#x6BD4;</span>
<span class="hljs-title">speedup</span> :: [(<span class="hljs-type">Operation</span>, <span class="hljs-type">Float</span>)]
<span class="hljs-title">speedup</span> = 
  [ (<span class="hljs-type">ADD</span>,    <span class="hljs-number">15.2</span>)
  , (<span class="hljs-type">SHA3</span>,   <span class="hljs-number">42.5</span>)
  , (<span class="hljs-type">SLOAD</span>,  <span class="hljs-number">18.7</span>)
  , (<span class="hljs-type">EXP</span>,    <span class="hljs-number">31.4</span>)
  ]
</code></pre>
<p><strong>&#x4F18;&#x5316;&#x5EFA;&#x8BAE;</strong>&#xFF1A;</p>
<ol>
<li>&#x4F7F;&#x7528;&#x5757;RAM&#x5B9E;&#x73B0;&#x6808;&#x7684;&#x6DF1;&#x5C42;&#x90E8;&#x5206;</li>
<li>SHA3&#x5E76;&#x884C;&#x5EA6;&#x53EF;&#x914D;&#x7F6E;(1/2/4&#x8DEF;)</li>
<li>&#x5B58;&#x50A8;&#x8BBF;&#x95EE;&#x4F7F;&#x7528;&#x7A81;&#x53D1;&#x4F20;&#x8F93;</li>
<li>&#x5173;&#x952E;&#x8DEF;&#x5F84;&#x4E0A;&#x907F;&#x514D;&#x8FC7;&#x5EA6;&#x7684;&#x7C7B;&#x578B;&#x5305;&#x88C5;</li>
</ol>
<h2 id="&#x672C;&#x7AE0;&#x5C0F;&#x7ED3;">&#x672C;&#x7AE0;&#x5C0F;&#x7ED3;</h2>
<p>&#x672C;&#x7AE0;&#x6DF1;&#x5165;&#x63A2;&#x8BA8;&#x4E86;&#x51FD;&#x6570;&#x5F0F;&#x786C;&#x4EF6;&#x63CF;&#x8FF0;&#x8BED;&#x8A00;Clash&#x7684;&#x8BBE;&#x8BA1;&#x7406;&#x5FF5;&#x4E0E;&#x5B9E;&#x8DF5;&#x5E94;&#x7528;&#xFF1A;</p>
<p><strong>&#x5173;&#x952E;&#x6982;&#x5FF5;</strong>&#xFF1A;</p>
<ul>
<li><strong>&#x7C7B;&#x578B;&#x5B89;&#x5168;</strong>&#xFF1A;&#x7F16;&#x8BD1;&#x65F6;&#x6355;&#x83B7;&#x786C;&#x4EF6;&#x8BBE;&#x8BA1;&#x9519;&#x8BEF;&#xFF0C;<code>Signal dom a</code>&#x7C7B;&#x578B;&#x786E;&#x4FDD;&#x65F6;&#x949F;&#x57DF;&#x5B89;&#x5168;</li>
<li><strong>&#x9AD8;&#x9636;&#x62BD;&#x8C61;</strong>&#xFF1A;<code>map</code>/<code>fold</code>/<code>scan</code>&#x7B49;&#x7EC4;&#x5408;&#x5B50;&#x76F4;&#x63A5;&#x6620;&#x5C04;&#x5230;&#x5E76;&#x884C;/&#x5F52;&#x7EA6;/&#x6D41;&#x6C34;&#x7EBF;&#x786C;&#x4EF6;&#x7ED3;&#x6784;</li>
<li><strong>&#x7EAF;&#x51FD;&#x6570;&#x5F0F;</strong>&#xFF1A;&#x65E0;&#x526F;&#x4F5C;&#x7528;&#x8BBE;&#x8BA1;&#x63D0;&#x9AD8;&#x53EF;&#x7EC4;&#x5408;&#x6027;&#x548C;&#x53EF;&#x9A8C;&#x8BC1;&#x6027;</li>
<li><strong>&#x72B6;&#x6001;&#x673A;&#x5EFA;&#x6A21;</strong>&#xFF1A;<code>moore</code>/<code>mealy</code>&#x6A21;&#x677F;&#x63D0;&#x4F9B;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;&#x72B6;&#x6001;&#x673A;&#x5B9E;&#x73B0;</li>
</ul>
<p><strong>Clash&#x4F18;&#x52BF;&#x603B;&#x7ED3;</strong>&#xFF1A;</p>
<ol>
<li><strong>&#x5F00;&#x53D1;&#x6548;&#x7387;</strong>&#xFF1A;&#x4EE3;&#x7801;&#x91CF;&#x51CF;&#x5C11;30-50%&#xFF0C;&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x9632;&#x6B62;&#x5E38;&#x89C1;&#x9519;&#x8BEF;</li>
<li><strong>&#x6027;&#x80FD;&#x53EF;&#x9884;&#x6D4B;</strong>&#xFF1A;&#x51FD;&#x6570;&#x5230;&#x786C;&#x4EF6;&#x7684;&#x6620;&#x5C04;&#x89C4;&#x5219;&#x660E;&#x786E;</li>
<li><strong>&#x6613;&#x4E8E;&#x9A8C;&#x8BC1;</strong>&#xFF1A;&#x7EAF;&#x51FD;&#x6570;&#x7279;&#x6027;&#x4FBF;&#x4E8E;&#x5F62;&#x5F0F;&#x5316;&#x9A8C;&#x8BC1;&#x548C;&#x5C5E;&#x6027;&#x6D4B;&#x8BD5;</li>
<li><strong>&#x6E10;&#x8FDB;&#x5F0F;&#x91C7;&#x7528;</strong>&#xFF1A;&#x652F;&#x6301;&#x4E0E;&#x73B0;&#x6709;Verilog/VHDL&#x7684;&#x65E0;&#x7F1D;&#x96C6;&#x6210;</li>
</ol>
<p><strong>EVM&#x52A0;&#x901F;&#x5668;&#x6848;&#x4F8B;&#x542F;&#x793A;</strong>&#xFF1A;</p>
<ul>
<li>&#x590D;&#x6742;&#x72B6;&#x6001;&#x673A;&#x7684;&#x51FD;&#x6570;&#x5F0F;&#x5EFA;&#x6A21;&#x4F18;&#x52BF;&#x660E;&#x663E;</li>
<li>&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x6709;&#x52A9;&#x4E8E;&#x6B63;&#x786E;&#x5B9E;&#x73B0;&#x534F;&#x8BAE;&#x89C4;&#x8303;</li>
<li>10-50x&#x7684;&#x6027;&#x80FD;&#x63D0;&#x5347;&#x8BC1;&#x660E;FPGA&#x52A0;&#x901F;&#x7684;&#x4EF7;&#x503C;</li>
</ul>
<h2 id="&#x7EC3;&#x4E60;&#x9898;">&#x7EC3;&#x4E60;&#x9898;</h2>
<h3 id="&#x57FA;&#x7840;&#x9898;">&#x57FA;&#x7840;&#x9898;</h3>
<ol>
<li><p><strong>&#x7C7B;&#x578B;&#x63A8;&#x5BFC;&#x7EC3;&#x4E60;</strong></p>
<p>&#x7ED9;&#x5B9A;Clash&#x51FD;&#x6570;&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-title">f</span> x y = register <span class="hljs-number">0</span> (x + register <span class="hljs-number">1</span> y)
</code></pre>
<p>&#x63A8;&#x5BFC;<code>f</code>&#x7684;&#x7C7B;&#x578B;&#x7B7E;&#x540D;&#x3002;</p>
<p><em>Hint: &#x8003;&#x8651;register&#x7684;&#x7C7B;&#x578B;&#x548C;Signal&#x7684;Functor&#x5B9E;&#x4F8B;</em></p>
<details>
<summary>&#x7B54;&#x6848;</summary>

&#x7C7B;&#x578B;&#x7B7E;&#x540D;&#x4E3A;&#xFF1A;
```haskell
f :: (Num a, NFDataX a) =&gt; Signal dom a -&gt; Signal dom a -&gt; Signal dom a
```

&#x63A8;&#x5BFC;&#x8FC7;&#x7A0B;&#xFF1A;
- `register :: NFDataX a =&gt; a -&gt; Signal dom a -&gt; Signal dom a`
- `register 1 y`&#x8981;&#x6C42;`y :: Signal dom a`
- `x + register 1 y`&#x8981;&#x6C42;`x :: Signal dom a`&#x4E14;`a`&#x6709;`Num`&#x5B9E;&#x4F8B;
- &#x6700;&#x5916;&#x5C42;`register 0`&#x786E;&#x5B9A;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;
</details>
</li>
<li><p><strong>&#x786C;&#x4EF6;&#x6620;&#x5C04;&#x7406;&#x89E3;</strong></p>
<p>&#x89E3;&#x91CA;&#x4EE5;&#x4E0B;Clash&#x4EE3;&#x7801;&#x751F;&#x6210;&#x7684;&#x786C;&#x4EF6;&#x7ED3;&#x6784;&#xFF1A;</p>
<pre><code class="lang-haskell"><span class="hljs-title">counter</span> = register <span class="hljs-number">0</span> (counter + <span class="hljs-number">1</span>)
</code></pre>
<p><em>Hint: &#x8003;&#x8651;&#x53CD;&#x9988;&#x56DE;&#x8DEF;&#x548C;&#x5BC4;&#x5B58;&#x5668;&#x4F4D;&#x7F6E;</em></p>
<details>
<summary>&#x7B54;&#x6848;</summary>

&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x5E26;&#x53CD;&#x9988;&#x7684;&#x8BA1;&#x6570;&#x5668;&#xFF1A;
- &#x4E00;&#x4E2A;&#x521D;&#x59CB;&#x503C;&#x4E3A;0&#x7684;&#x5BC4;&#x5B58;&#x5668;
- &#x5BC4;&#x5B58;&#x5668;&#x8F93;&#x51FA;&#x8FDE;&#x63A5;&#x5230;&#x52A0;&#x6CD5;&#x5668;&#x8F93;&#x5165;
- &#x52A0;&#x6CD5;&#x5668;&#x53E6;&#x4E00;&#x8F93;&#x5165;&#x4E3A;&#x5E38;&#x6570;1
- &#x52A0;&#x6CD5;&#x5668;&#x8F93;&#x51FA;&#x8FDE;&#x56DE;&#x5BC4;&#x5B58;&#x5668;&#x8F93;&#x5165;
- &#x5F62;&#x6210;&#x81EA;&#x589E;&#x8BA1;&#x6570;&#x5668;&#xFF0C;&#x6BCF;&#x65F6;&#x949F;&#x5468;&#x671F;+1
</details>
</li>
<li><p><strong>&#x72B6;&#x6001;&#x673A;&#x5B9E;&#x73B0;</strong></p>
<p>&#x4F7F;&#x7528;Clash&#x7684;<code>moore</code>&#x51FD;&#x6570;&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x68C0;&#x6D4B;&quot;101&quot;&#x5E8F;&#x5217;&#x7684;&#x72B6;&#x6001;&#x673A;&#x3002;&#x5B9A;&#x4E49;&#x72B6;&#x6001;&#x7C7B;&#x578B;&#x548C;&#x8F6C;&#x79FB;&#x51FD;&#x6570;&#x3002;</p>
<p><em>Hint: &#x9700;&#x8981;4&#x4E2A;&#x72B6;&#x6001;&#xFF1A;IDLE&#x3001;SAW_1&#x3001;SAW_10&#x3001;SAW_101</em></p>
<details>
<summary>&#x7B54;&#x6848;</summary>

```haskell
data State = IDLE | SAW_1 | SAW_10 | SAW_101

transition :: State -&gt; Bit -&gt; State
transition IDLE     1 = SAW_1
transition IDLE     0 = IDLE
transition SAW_1    0 = SAW_10
transition SAW_1    1 = SAW_1
transition SAW_10   1 = SAW_101
transition SAW_10   0 = IDLE
transition SAW_101  _ = IDLE

output :: State -&gt; Bit
output SAW_101 = 1
output _       = 0

detector = moore transition output IDLE
```
</details>
</li>
<li><p><strong>&#x8D44;&#x6E90;&#x4F30;&#x7B97;</strong></p>
<p>&#x4F30;&#x7B97;8&#x4F4D;&#xD7;8&#x4F4D;&#x6D41;&#x6C34;&#x7EBF;&#x4E58;&#x6CD5;&#x5668;&#x5728;Zynq-7020&#x4E0A;&#x7684;&#x8D44;&#x6E90;&#x4F7F;&#x7528;&#x3002;&#x5047;&#x8BBE;&#x4F7F;&#x7528;3&#x7EA7;&#x6D41;&#x6C34;&#x7EBF;&#x3002;</p>
<p><em>Hint: &#x8003;&#x8651;DSP48E1&#x539F;&#x8BED;&#x548C;&#x5BC4;&#x5B58;&#x5668;&#x6570;&#x91CF;</em></p>
<details>
<summary>&#x7B54;&#x6848;</summary>

&#x8D44;&#x6E90;&#x4F30;&#x7B97;&#xFF1A;
- DSP48E1: 1&#x4E2A;&#xFF08;&#x539F;&#x751F;&#x652F;&#x6301;18&#xD7;25&#x4F4D;&#xFF09;
- &#x5BC4;&#x5B58;&#x5668;: ~48&#x4E2A;&#xFF08;3&#x7EA7;&#xD7;16&#x4F4D;&#x4E2D;&#x95F4;&#x7ED3;&#x679C;&#xFF09;
- LUTs: ~20&#x4E2A;&#xFF08;&#x63A7;&#x5236;&#x903B;&#x8F91;&#xFF09;
- &#x53EF;&#x8FBE;&#x65F6;&#x949F;&#x9891;&#x7387;: ~300MHz
</details>

</li>
</ol>
<h3 id="&#x6311;&#x6218;&#x9898;">&#x6311;&#x6218;&#x9898;</h3>
<ol>
<li><p><strong>&#x9AD8;&#x9636;&#x51FD;&#x6570;&#x786C;&#x4EF6;&#x6620;&#x5C04;</strong></p>
<p>&#x8BBE;&#x8BA1;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x5316;&#x7684;FIR&#x6EE4;&#x6CE2;&#x5668;&#x751F;&#x6210;&#x5668;&#xFF0C;&#x63A5;&#x53D7;&#x7CFB;&#x6570;&#x5411;&#x91CF;&#x4F5C;&#x4E3A;&#x53C2;&#x6570;&#x3002;&#x5206;&#x6790;&#x4E0D;&#x540C;&#x7CFB;&#x6570;&#x6570;&#x91CF;&#x5BF9;&#x8D44;&#x6E90;&#x7684;&#x5F71;&#x54CD;&#x3002;</p>
<p><em>Hint: &#x4F7F;&#x7528;<code>zipWith</code>&#x548C;<code>fold</code>&#x7EC4;&#x5408;&#x5B9E;&#x73B0;&#x5377;&#x79EF;</em></p>
<details>
<summary>&#x7B54;&#x6848;</summary>

&#x8BBE;&#x8BA1;&#x601D;&#x8DEF;&#xFF1A;
```haskell
fir :: (KnownNat n, Num a, NFDataX a) 
    =&gt; Vec n a                        -- &#x7CFB;&#x6570;
    -&gt; Signal dom a                   -- &#x8F93;&#x5165;
    -&gt; Signal dom a                   -- &#x8F93;&#x51FA;
fir coeffs x = fold (+) $ zipWith (*) coeffs delays
  where
    delays = generate delay (register 0)
```

&#x8D44;&#x6E90;&#x5206;&#x6790;&#xFF1A;
- N&#x4E2A;&#x7CFB;&#x6570;&#x9700;&#x8981;N&#x4E2A;&#x4E58;&#x6CD5;&#x5668;(DSP48)
- N-1&#x4E2A;&#x52A0;&#x6CD5;&#x5668;&#xFF08;&#x6811;&#x5F62;&#x5F52;&#x7EA6;&#xFF09;
- N&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x5B58;&#x50A8;&#x5EF6;&#x8FDF;&#x7EBF;
- &#x5173;&#x952E;&#x8DEF;&#x5F84;&#xFF1A;log(N)&#x7EA7;&#x52A0;&#x6CD5;&#x5668;&#x5EF6;&#x8FDF;
</details>
</li>
<li><p><strong>&#x8DE8;&#x65F6;&#x949F;&#x57DF;&#x8BBE;&#x8BA1;</strong></p>
<p>&#x5B9E;&#x73B0;&#x4E00;&#x4E2A;&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x7684;&#x5F02;&#x6B65;FIFO&#xFF0C;&#x786E;&#x4FDD;&#x8BFB;&#x5199;&#x65F6;&#x949F;&#x57DF;&#x5206;&#x79BB;&#x3002;&#x4F7F;&#x7528;Gray&#x7801;&#x6307;&#x9488;&#x9632;&#x6B62;&#x4E9A;&#x7A33;&#x6001;&#x3002;</p>
<p><em>Hint: &#x4F7F;&#x7528;<code>unsafeSynchronizer</code>&#x5E76;&#x8BC1;&#x660E;&#x5176;&#x5B89;&#x5168;&#x6027;</em></p>
<details>
<summary>&#x7B54;&#x6848;</summary>

&#x5173;&#x952E;&#x8BBE;&#x8BA1;&#x8981;&#x70B9;&#xFF1A;
- &#x5B9A;&#x4E49;&#x4E24;&#x4E2A;&#x65F6;&#x949F;&#x57DF;&#x7C7B;&#x578B;&#xFF1A;`DomainA`&#x548C;`DomainB`
- &#x8BFB;&#x5199;&#x6307;&#x9488;&#x4F7F;&#x7528;Gray&#x7801;&#x7F16;&#x7801;
- &#x6307;&#x9488;&#x540C;&#x6B65;&#x4F7F;&#x7528;2&#x7EA7;&#x5BC4;&#x5B58;&#x5668;&#x94FE;
- &#x7A7A;/&#x6EE1;&#x6807;&#x5FD7;&#x751F;&#x6210;&#x8003;&#x8651;&#x540C;&#x6B65;&#x5EF6;&#x8FDF;
- &#x4F7F;&#x7528;phantom&#x7C7B;&#x578B;&#x786E;&#x4FDD;&#x57DF;&#x5206;&#x79BB;

&#x6838;&#x5FC3;&#x540C;&#x6B65;&#x903B;&#x8F91;&#xFF1A;
```haskell
-- Gray&#x7801;&#x8F6C;&#x6362;&#x4FDD;&#x8BC1;&#x5355;bit&#x53D8;&#x5316;
grayEncode :: Unsigned n -&gt; Unsigned n
grayEncode x = x `xor` (x `shiftR` 1)
```
</details>
</li>
<li><p><strong>&#x5F62;&#x5F0F;&#x5316;&#x9A8C;&#x8BC1;&#x96C6;&#x6210;</strong></p>
<p>&#x5982;&#x4F55;&#x5C06;Clash&#x8BBE;&#x8BA1;&#x4E0E;SMT&#x6C42;&#x89E3;&#x5668;(&#x5982;Z3)&#x96C6;&#x6210;&#xFF0C;&#x5B9E;&#x73B0;&#x6709;&#x754C;&#x6A21;&#x578B;&#x68C0;&#x67E5;&#xFF1F;&#x8BBE;&#x8BA1;&#x4E00;&#x4E2A;&#x9A8C;&#x8BC1;&#x6D41;&#x7A0B;&#x3002;</p>
<p><em>Hint: &#x8003;&#x8651;&#x5C06;Clash&#x7684;Core&#x8868;&#x793A;&#x8F6C;&#x6362;&#x4E3A;SMT&#x516C;&#x5F0F;</em></p>
<details>
<summary>&#x7B54;&#x6848;</summary>

&#x9A8C;&#x8BC1;&#x6D41;&#x7A0B;&#x8BBE;&#x8BA1;&#xFF1A;
1. **&#x63D0;&#x53D6;&#x9A8C;&#x8BC1;&#x6761;&#x4EF6;**&#xFF1A;&#x4ECE;Clash&#x7C7B;&#x578B;&#x548C;&#x65AD;&#x8A00;&#x751F;&#x6210;
2. **&#x7B26;&#x53F7;&#x6267;&#x884C;**&#xFF1A;&#x5C55;&#x5F00;&#x6709;&#x9650;&#x6B65;&#x9AA4;&#x7684;&#x72B6;&#x6001;&#x8F6C;&#x79FB;
3. **SMT&#x7F16;&#x7801;**&#xFF1A;
   - &#x5BC4;&#x5B58;&#x5668;&#x2192;SMT&#x53D8;&#x91CF;
   - &#x7EC4;&#x5408;&#x903B;&#x8F91;&#x2192;SMT&#x516C;&#x5F0F;
   - &#x65F6;&#x5E8F;&#x7EA6;&#x675F;&#x2192;&#x8574;&#x542B;&#x5173;&#x7CFB;
4. **&#x53CD;&#x4F8B;&#x5206;&#x6790;**&#xFF1A;&#x5C06;SMT&#x6A21;&#x578B;&#x6620;&#x5C04;&#x56DE;Clash&#x503C;
5. **&#x589E;&#x91CF;&#x9A8C;&#x8BC1;**&#xFF1A;&#x5229;&#x7528;&#x8BBE;&#x8BA1;&#x5C42;&#x6B21;&#x7ED3;&#x6784;

&#x5DE5;&#x5177;&#x94FE;&#xFF1A;Clash &#x2192; Core &#x2192; SMT-LIB2 &#x2192; Z3
</details>
</li>
<li><p><strong>&#x5F00;&#x653E;&#x8BBE;&#x8BA1;&#xFF1A;&#x795E;&#x7ECF;&#x7F51;&#x7EDC;&#x91CF;&#x5316;&#x63A8;&#x7406;&#x52A0;&#x901F;&#x5668;</strong></p>
<p>&#x4F7F;&#x7528;Clash&#x8BBE;&#x8BA1;&#x4E00;&#x4E2A;INT8&#x91CF;&#x5316;&#x7684;&#x5377;&#x79EF;&#x5C42;&#x52A0;&#x901F;&#x5668;&#x3002;&#x8003;&#x8651;&#xFF1A;</p>
<ul>
<li>&#x5982;&#x4F55;&#x5229;&#x7528;&#x7C7B;&#x578B;&#x7CFB;&#x7EDF;&#x4FDD;&#x8BC1;&#x91CF;&#x5316;&#x7CBE;&#x5EA6;&#xFF1F;</li>
<li>&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x9AD8;&#x6548;&#x7684;im2col&#x53D8;&#x6362;&#xFF1F;</li>
<li>&#x5982;&#x4F55;&#x4F18;&#x5316;&#x7247;&#x4E0A;&#x5B58;&#x50A8;&#x5C42;&#x6B21;&#xFF1F;</li>
</ul>
<p><em>Hint: &#x8003;&#x8651;&#x4F7F;&#x7528;Fixed&#x5B9A;&#x70B9;&#x6570;&#x7C7B;&#x578B;&#x548C;&#x5757;&#x5316;&#x77E9;&#x9635;&#x4E58;&#x6CD5;</em></p>
<details>
<summary>&#x7B54;&#x6848;</summary>

&#x8BBE;&#x8BA1;&#x8003;&#x8651;&#xFF1A;
1. **&#x7C7B;&#x578B;&#x5B89;&#x5168;&#x91CF;&#x5316;**&#xFF1A;
   - `SFixed 8 0`&#x8868;&#x793A;INT8
   - &#x91CF;&#x5316;&#x53C2;&#x6570;&#x4F5C;&#x4E3A;&#x7C7B;&#x578B;&#x53C2;&#x6570;&#x4F20;&#x9012;

2. **im2col&#x4F18;&#x5316;**&#xFF1A;
   - &#x4F7F;&#x7528;&#x5FAA;&#x73AF;&#x7F13;&#x51B2;&#x533A;&#x51CF;&#x5C11;&#x91CD;&#x590D;&#x8BFB;&#x53D6;
   - &#x884C;&#x7F13;&#x5B58;&#x6DF1;&#x5EA6;=&#x5377;&#x79EF;&#x6838;&#x9AD8;&#x5EA6;

3. **&#x5B58;&#x50A8;&#x5C42;&#x6B21;**&#xFF1A;
   - L1: &#x5BC4;&#x5B58;&#x5668;&#x9635;&#x5217;&#x5B58;&#x50A8;&#x5F53;&#x524D;tile
   - L2: BRAM&#x5B58;&#x50A8;&#x591A;&#x4E2A;&#x8F93;&#x5165;&#x901A;&#x9053;
   - L3: &#x5916;&#x90E8;DDR&#x6D41;&#x5F0F;&#x8BFB;&#x53D6;

4. **&#x8BA1;&#x7B97;&#x9635;&#x5217;**&#xFF1A;
   - 8&#xD7;8&#x8109;&#x52A8;&#x9635;&#x5217;
   - &#x6743;&#x91CD;&#x56FA;&#x5B9A;&#xFF0C;&#x6FC0;&#x6D3B;&#x503C;&#x6D41;&#x52A8;
   - &#x90E8;&#x5206;&#x548C;&#x7D2F;&#x52A0;&#x4F7F;&#x7528;&#x66F4;&#x5BBD;&#x4F4D;&#x5BBD;

&#x9884;&#x671F;&#x6027;&#x80FD;&#xFF1A;
- 1TOPS @ 200MHz (&#x7406;&#x8BBA;&#x5CF0;&#x503C;)
- &#x5B9E;&#x9645;&#x5229;&#x7528;&#x7387;~70%&#x8003;&#x8651;&#x6570;&#x636E;&#x642C;&#x8FD0;
</details>

</li>
</ol>
<h2 id="&#x5E38;&#x89C1;&#x9677;&#x9631;&#x4E0E;&#x9519;&#x8BEF;">&#x5E38;&#x89C1;&#x9677;&#x9631;&#x4E0E;&#x9519;&#x8BEF;</h2>
<ol>
<li><p><strong>&#x9690;&#x5F0F;&#x5171;&#x4EAB;&#x5BFC;&#x81F4;&#x7684;&#x8D44;&#x6E90;&#x7206;&#x70B8;</strong></p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x9519;&#x8BEF;&#xFF1A;&#x6BCF;&#x6B21;&#x4F7F;&#x7528;expensive&#x90FD;&#x4F1A;&#x590D;&#x5236;&#x786C;&#x4EF6;</span>
<span class="hljs-title">let</span> expensive = complexCalculation x
<span class="hljs-title">in</span> expensive + expensive

<span class="hljs-comment">-- &#x6B63;&#x786E;&#xFF1A;&#x4F7F;&#x7528;register&#x6253;&#x7834;&#x5171;&#x4EAB;</span>
<span class="hljs-title">let</span> expensive = register <span class="hljs-number">0</span> (complexCalculation x)
</code></pre>
</li>
<li><p><strong>&#x65E0;&#x9650;&#x9012;&#x5F52;&#x751F;&#x6210;&#x65E0;&#x9650;&#x786C;&#x4EF6;</strong></p>
<pre><code class="lang-haskell"><span class="hljs-comment">-- &#x9519;&#x8BEF;&#xFF1A;&#x751F;&#x6210;&#x65E0;&#x9650;&#x6DF1;&#x5EA6;&#x7684;&#x7535;&#x8DEF;</span>
<span class="hljs-title">infiniteAdder</span> x = x + infiniteAdder x

<span class="hljs-comment">-- &#x6B63;&#x786E;&#xFF1A;&#x4F7F;&#x7528;register&#x5F15;&#x5165;&#x65F6;&#x5E8F;&#x8FB9;&#x754C;</span>
<span class="hljs-title">accumulator</span> x = register <span class="hljs-number">0</span> (x + accumulator x)
</code></pre>
</li>
<li><p><strong>&#x7C7B;&#x578B;&#x63A8;&#x5BFC;&#x5931;&#x8D25;</strong></p>
<ul>
<li>&#x75C7;&#x72B6;&#xFF1A;&#x795E;&#x79D8;&#x7684;&#x7C7B;&#x578B;&#x9519;&#x8BEF;&#x4FE1;&#x606F;</li>
<li>&#x539F;&#x56E0;&#xFF1A;&#x7F3A;&#x5C11;&#x7C7B;&#x578B;&#x6807;&#x6CE8;&#x5BFC;&#x81F4;&#x6B67;&#x4E49;</li>
<li>&#x89E3;&#x51B3;&#xFF1A;&#x663E;&#x5F0F;&#x6807;&#x6CE8;&#x9876;&#x5C42;&#x51FD;&#x6570;&#x7C7B;&#x578B;</li>
</ul>
</li>
<li><p><strong>&#x65F6;&#x949F;&#x57DF;&#x6DF7;&#x6DC6;</strong></p>
<ul>
<li>&#x75C7;&#x72B6;&#xFF1A;&#x7EFC;&#x5408;&#x5931;&#x8D25;&#x6216;&#x65F6;&#x5E8F;&#x8FDD;&#x4F8B;</li>
<li>&#x539F;&#x56E0;&#xFF1A;&#x4E0D;&#x540C;&#x65F6;&#x949F;&#x57DF;&#x4FE1;&#x53F7;&#x76F4;&#x63A5;&#x8FDE;&#x63A5;</li>
<li>&#x89E3;&#x51B3;&#xFF1A;&#x4F7F;&#x7528;&#x5B98;&#x65B9;&#x540C;&#x6B65;&#x539F;&#x8BED;</li>
</ul>
</li>
<li><p><strong>BlackBox&#x63A5;&#x53E3;&#x4E0D;&#x5339;&#x914D;</strong></p>
<ul>
<li>&#x75C7;&#x72B6;&#xFF1A;&#x4EFF;&#x771F;&#x6B63;&#x786E;&#x4F46;&#x7EFC;&#x5408;&#x5931;&#x8D25;</li>
<li>&#x539F;&#x56E0;&#xFF1A;Haskell&#x7C7B;&#x578B;&#x4E0E;HDL&#x63A5;&#x53E3;&#x4E0D;&#x4E00;&#x81F4;</li>
<li>&#x89E3;&#x51B3;&#xFF1A;&#x4ED4;&#x7EC6;&#x68C0;&#x67E5;&#x7AEF;&#x53E3;&#x540D;&#x548C;&#x4F4D;&#x5BBD;</li>
</ul>
</li>
</ol>
<h2 id="&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#x68C0;&#x67E5;&#x6E05;&#x5355;">&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#x68C0;&#x67E5;&#x6E05;&#x5355;</h2>
<h3 id="&#x8BBE;&#x8BA1;&#x9636;&#x6BB5;">&#x8BBE;&#x8BA1;&#x9636;&#x6BB5;</h3>
<ul>
<li>[ ] &#x6240;&#x6709;&#x9876;&#x5C42;&#x51FD;&#x6570;&#x90FD;&#x6709;&#x660E;&#x786E;&#x7684;&#x7C7B;&#x578B;&#x7B7E;&#x540D;</li>
<li>[ ] &#x65F6;&#x949F;&#x57DF;&#x8FB9;&#x754C;&#x4F7F;&#x7528;appropriate&#x540C;&#x6B65;&#x539F;&#x8BED;</li>
<li>[ ] &#x9012;&#x5F52;&#x5B9A;&#x4E49;&#x90FD;&#x901A;&#x8FC7;register&#x6253;&#x7834;&#x7EC4;&#x5408;&#x73AF;&#x8DEF;</li>
<li>[ ] &#x4F7F;&#x7528;<code>NFDataX</code>&#x7EA6;&#x675F;&#x786E;&#x4FDD;&#x7C7B;&#x578B;&#x53EF;&#x7EFC;&#x5408;</li>
<li>[ ] phantom&#x7C7B;&#x578B;&#x6807;&#x8BB0;&#x4E0D;&#x540C;&#x7684;&#x63A5;&#x53E3;&#x534F;&#x8BAE;</li>
</ul>
<h3 id="&#x7F16;&#x7801;&#x89C4;&#x8303;">&#x7F16;&#x7801;&#x89C4;&#x8303;</h3>
<ul>
<li>[ ] &#x6A21;&#x5757;&#x5212;&#x5206;&#x9075;&#x5FAA;&#x529F;&#x80FD;&#x8FB9;&#x754C;</li>
<li>[ ] &#x72B6;&#x6001;&#x673A;&#x4F7F;&#x7528;ADT&#x660E;&#x786E;&#x5EFA;&#x6A21;&#x6240;&#x6709;&#x72B6;&#x6001;</li>
<li>[ ] &#x907F;&#x514D;&#x90E8;&#x5206;&#x51FD;&#x6570;&#xFF0C;&#x4F7F;&#x7528;total functions</li>
<li>[ ] &#x9519;&#x8BEF;&#x5904;&#x7406;&#x4F7F;&#x7528;Maybe/Either&#x800C;&#x975E;&#x5F02;&#x5E38;</li>
<li>[ ] &#x5173;&#x952E;&#x8DEF;&#x5F84;&#x6807;&#x6CE8;expectedCycleTime</li>
</ul>
<h3 id="&#x9A8C;&#x8BC1;&#x7B56;&#x7565;">&#x9A8C;&#x8BC1;&#x7B56;&#x7565;</h3>
<ul>
<li>[ ] &#x7F16;&#x5199;QuickCheck&#x5C5E;&#x6027;&#x6D4B;&#x8BD5;</li>
<li>[ ] &#x5173;&#x952E;&#x6A21;&#x5757;&#x8FDB;&#x884C;&#x5F62;&#x5F0F;&#x5316;&#x9A8C;&#x8BC1;</li>
<li>[ ] &#x4E0E;golden model&#x8FDB;&#x884C;&#x534F;&#x540C;&#x4EFF;&#x771F;</li>
<li>[ ] &#x8986;&#x76D6;&#x7387;&#x5305;&#x62EC;&#x72B6;&#x6001;&#x7A7A;&#x95F4;&#x63A2;&#x7D22;</li>
<li>[ ] &#x65F6;&#x5E8F;&#x7EA6;&#x675F;&#x901A;&#x8FC7;&#x9759;&#x6001;&#x65F6;&#x5E8F;&#x5206;&#x6790;&#x9A8C;&#x8BC1;</li>
</ul>
<h3 id="&#x6027;&#x80FD;&#x4F18;&#x5316;">&#x6027;&#x80FD;&#x4F18;&#x5316;</h3>
<ul>
<li>[ ] &#x8BC6;&#x522B;&#x5E76;&#x4F18;&#x5316;&#x5173;&#x952E;&#x8DEF;&#x5F84;</li>
<li>[ ] &#x5408;&#x7406;&#x4F7F;&#x7528;retiming&#x4F18;&#x5316;</li>
<li>[ ] &#x8D44;&#x6E90;&#x5171;&#x4EAB;&#x901A;&#x8FC7;&#x663E;&#x5F0F;&#x8C03;&#x5EA6;</li>
<li>[ ] &#x6D41;&#x6C34;&#x7EBF;&#x6DF1;&#x5EA6;&#x4E0E;&#x541E;&#x5410;&#x91CF;&#x5E73;&#x8861;</li>
<li>[ ] &#x529F;&#x8017;&#x654F;&#x611F;&#x8BBE;&#x8BA1;&#x4F7F;&#x7528;&#x65F6;&#x949F;&#x95E8;&#x63A7;</li>
</ul>
<h3 id="&#x96C6;&#x6210;&#x90E8;&#x7F72;">&#x96C6;&#x6210;&#x90E8;&#x7F72;</h3>
<ul>
<li>[ ] &#x751F;&#x6210;&#x7684;HDL&#x901A;&#x8FC7;lint&#x68C0;&#x67E5;</li>
<li>[ ] &#x4FDD;&#x7559;&#x6E90;&#x7801;&#x5230;HDL&#x7684;&#x8FFD;&#x8E2A;&#x4FE1;&#x606F;</li>
<li>[ ] &#x7248;&#x672C;&#x63A7;&#x5236;&#x5305;&#x62EC;&#x4F9D;&#x8D56;&#x7BA1;&#x7406;</li>
<li>[ ] CI/CD&#x96C6;&#x6210;&#x81EA;&#x52A8;&#x5316;&#x6D4B;&#x8BD5;</li>
<li>[ ] &#x6587;&#x6863;&#x5305;&#x62EC;&#x7C7B;&#x578B;&#x7B7E;&#x540D;&#x548C;&#x786C;&#x4EF6;&#x6620;&#x5C04;&#x8BF4;&#x660E;</li>
</ul>
<hr>
<div style="text-align: center; margin: 20px 0;">
  <a href="chapter7.html" style="margin-right: 20px;">&#x2190; &#x4E0A;&#x4E00;&#x7AE0;&#xFF1A;&#x672A;&#x6765;&#x8D8B;&#x52BF;&#x4E0E;&#x65B0;&#x5174;&#x6280;&#x672F;</a>
  <a href="chapter9.html" style="margin-left: 20px;">&#x4E0B;&#x4E00;&#x7AE0;&#xFF1A;OCaml/Hardcaml&#x786C;&#x4EF6;&#x8BBE;&#x8BA1; &#x2192;</a>
</div>



<script type="text/javascript">var targetUl = document.getElementsByClassName('page-inner')[0].getElementsByTagName('ul')[0];if(targetUl.getElementsByTagName('a').length>0){targetUl.className='toc';}</script>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="chapter7.html" class="navigation navigation-prev " aria-label="Previous page: 第7章：HLS与C到硬件综合">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="chapter9.html" class="navigation navigation-next " aria-label="Next page: 第9章：OCaml/Hardcaml硬件设计">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"第8章：函数式HDL之Haskell/Clash","level":"3.4","depth":1,"next":{"title":"第9章：OCaml/Hardcaml硬件设计","level":"3.5","depth":1,"path":"chapters/chapter9.md","ref":"chapters/chapter9.md","articles":[]},"previous":{"title":"第7章：HLS与C到硬件综合","level":"3.3","depth":1,"path":"chapters/chapter7.md","ref":"chapters/chapter7.md","articles":[]},"dir":"ltr"},"config":{"plugins":["expandable-chapters","search","copy-code-button","theme-default","back-to-top-button","github","splitter","toc"],"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"assets/css/website.css"},"pluginsConfig":{"github":{"url":"https://github.com/Xde1997/Tutorial_FPGA"},"splitter":{},"toc":{"addClass":true,"className":"toc"},"search":{"maxIndexSize":100000,"ignoreCase":true},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"back-to-top-button":{},"copy-code-button":{"copyText":"复制代码","format":"html"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"showLevel":true,"styles":{"ebook":"styles/ebook.css","epub":"styles/epub.css","mobi":"styles/mobi.css","pdf":"styles/pdf.css","print":"styles/print.css","website":"assets/css/website.css"}},"expandable-chapters":{"chapterExpand":true,"chapterRespectURL":true}},"theme":"default","author":"FPGA教程团队","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{"themeColor":"#2196F3","themeColorSecondary":"#FF5722"},"title":"FPGA原理与AI加速应用教程","language":"zh-hans","gitbook":"*","description":"面向软件工程师的FPGA实战指南"},"file":{"path":"chapters/chapter8.md","mtime":"2025-08-03T13:01:37.037Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2025-08-03T13:02:29.579Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

